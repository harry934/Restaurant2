<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="Responsive Bootstrap4 Shop Template, Created by Imran Hossain from https://imransdesign.com/">

	<!-- title -->
	<title>Checkout - Kibby's Hot Kitchen</title>

	<!-- favicon -->
	<link rel="shortcut icon" type="image/png" href="assets/img/favicon.png">
	<!-- google font -->
	<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Poppins:400,700&display=swap" rel="stylesheet">
	<!-- fontawesome -->
	<link rel="stylesheet" href="assets/css/all.min.css">
	<!-- bootstrap -->
	<link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
	<!-- owl carousel -->
	<link rel="stylesheet" href="assets/css/owl.carousel.css">
	<!-- magnific popup -->
	<link rel="stylesheet" href="assets/css/magnific-popup.css">
	<!-- animate css -->
	<link rel="stylesheet" href="assets/css/animate.css">
	<!-- mean menu css -->
	<link rel="stylesheet" href="assets/css/meanmenu.min.css">
	<!-- main style -->
	<link rel="stylesheet" href="assets/css/main.css">
	<!-- responsive -->
	<link rel="stylesheet" href="assets/css/responsive.css">
    
    <!-- Leaflet Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* Modern Checkout Refinements */
        .checkout-section { background: #fbfbfb; }
        .checkout-card { 
            background: #fff; 
            padding: 25px; 
            border-radius: 24px; 
            box-shadow: 0 15px 50px rgba(0,0,0,0.04); 
            margin-bottom: 40px;
            border: 1px solid #f0f0f0;
        }
        
        .checkout-step-title {
            font-weight: 800; 
            color: #1a1a1a; 
            margin-bottom: 25px; 
            display: flex; 
            align-items: center;
            font-size: 1.25rem;
        }
        .checkout-step-number {
            background: #c11b17; 
            color: #fff; 
            width: 32px; 
            height: 32px; 
            border-radius: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 0.9rem; 
            margin-right: 15px;
            flex-shrink: 0;
            box-shadow: 0 4px 10px rgba(193, 27, 23, 0.2);
        }

        .input-group-pcnc { margin-bottom: 20px; }
        .input-group-pcnc label {
            font-weight: 700; 
            font-size: 0.75rem; 
            color: #999; 
            text-transform: uppercase; 
            margin-bottom: 10px; 
            margin-left: 5px; 
            display: block;
            letter-spacing: 0.5px;
        }
        .input-group-pcnc input, .input-group-pcnc textarea {
            width: 100%; 
            padding: 16px 22px; 
            border: 2px solid #f4f4f4; 
            border-radius: 16px; 
            background: #fdfdfd; 
            color: #333; 
            font-weight: 600; 
            outline: none;
            transition: all 0.3s ease;
        }
        .input-group-pcnc input:focus, .input-group-pcnc textarea:focus {
            border-color: #c11b17;
            background: #fff;
            box-shadow: 0 5px 15px rgba(193, 27, 23, 0.05);
        }

        /* Search Container Fixes */
        .location-search-wrapper { position: relative; }
        .location-search-wrapper input { padding-right: 100px; }
        .search-actions {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .locate-me-btn {
            background: #c11b17;
            color: #fff;
            border: none;
            width: 38px;
            height: 38px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
            box-shadow: 0 4px 12px rgba(231, 37, 45, 0.2);
        }
        .locate-me-btn:hover { background: #116940; transform: translateY(-2px); }
        .search-icon-fixed { color: #e7252d; font-size: 1.1rem; margin-right: 10px; }

        /* Payment UI */
        .payment-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .pm-card {
            border: 2px solid #f4f4f4 !important;
            padding: 20px !important;
            border-radius: 20px !important;
            position: relative;
            cursor: pointer;
            transition: 0.3s;
            background: #fff;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            height: 100%;
        }
        .pm-card.active {
            border-color: #e7252d !important;
            background: #fff8f8 !important;
            box-shadow: 0 10px 25px rgba(231, 37, 45, 0.08) !important;
        }
        .pm-card i { font-size: 32px; margin-bottom: 15px; }

        #locationMap {
            height: 300px;
            width: 100%;
            border-radius: 20px;
            margin-top: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            border: 4px solid #fff;
            display: none;
        }

        /* Summary Table */
        .summary-table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
        .summary-item-row { background: #fdfdfd; border-radius: 12px; }
        .summary-item-row td { padding: 15px; }
        .summary-item-row td:first-child { border-radius: 12px 0 0 12px; }
        .summary-item-row td:last-child { border-radius: 0 12px 12px 0; }

        @media (max-width: 768px) {
            .payment-grid { grid-template-columns: 1fr; }
            .checkout-card { padding: 20px; }
            .location-search-wrapper input { padding-right: 90px; }
            .checkout-step-title { font-size: 1.1rem; }
        }
    </style>

</head>
<body>
	
	<!--PreLoader-->
    <div class="loader">
        <div class="loader-inner">
            <div class="circle"></div>
        </div>
    </div>
    <!--PreLoader Ends-->
	
	<!-- header -->
	<div class="top-header-area" id="sticker">
		<div class="container">
			<div class="row">
				<div class="col-lg-12 col-sm-12 text-center">
					<div class="main-menu-wrap">
						<!-- logo -->
						<div class="site-logo">
							<a href="index.html">
								<img src="assets/img/kibbys-logo.png" alt="Kibby's Hot Kitchen Logo">
							</a>
						</div>
						<!-- logo -->

						<!-- menu start -->
						<nav class="main-menu">
							<ul>
								<li><a href="index.html">Home</a></li>
								<li><a href="about.html">About</a></li>
								<li><a href="shop.html">Menu</a></li>
								<li class="current-list-item"><a href="checkout.html">Checkout</a></li>
								<li><a href="track-order.html">Track Order</a></li>
								<li>
									<a class="shopping-cart" href="cart.html">
										<i class="fas fa-shopping-cart"></i>
										<span class="cart-count-badge pcnc-header-badge" style="display: none;">0</span>
									</a>
								</li>
							</ul>
						</nav>
						<!-- menu end -->
						<!-- menu end -->
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- end header -->
	
	<!-- breadcrumb-section -->
	<div class="breadcrumb-section breadcrumb-bg">
		<div class="container">
			<div class="row">
				<div class="col-lg-8 offset-lg-2 text-center">
					<div class="breadcrumb-text">
						<p>Fresh & Tasty</p>
						<h1>Checkout</h1>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- end breadcrumb section -->

	<!-- check out section -->
	<div class="checkout-section mt-80 mb-150">
		<div class="container">
			<div class="row justify-content-center">
				<div class="col-lg-8">
					
					<form id="checkout-form">
					<form id="checkout-form">
						<!-- Section 1: Customer & Delivery -->
						<div class="checkout-card">
							<h4 class="checkout-step-title">
								<span class="checkout-step-number">1</span>
								Delivery Details
							</h4>
							
							<div class="row">
								<div class="col-md-6">
									<div class="input-group-pcnc">
										<label>Full Name</label>
										<input type="text" id="name" placeholder="Enter your name" required>
									</div>
								</div>
								<div class="col-md-6">
									<div class="input-group-pcnc">
										<label>Phone Number</label>
										<input type="tel" id="phone" placeholder="07XXXXXXXX" required>
									</div>
								</div>
								<div class="col-12">
									<div class="input-group-pcnc">
										<label>Delivery Area / Hostel Name</label>
										<div class="location-search-wrapper">
											<input type="text" id="address" placeholder="e.g. Priwanna, USIU, Qwetu, Roysambu..." required autocomplete="off">
											<div class="search-actions">
												<button type="button" class="locate-me-btn" onclick="locateMe()" title="Use GPS">
													<i class="fas fa-location-arrow"></i>
												</button>
												<i class="fas fa-map-marker-alt" style="color: #e7252d; margin-right: 15px;"></i>
											</div>
											<div id="location-suggestions" style="position: absolute; top: 100%; left: 0; right: 0; background: #fff; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); z-index: 1000; display: none; overflow: hidden; border: 1px solid #eee; margin-top: 5px;"></div>
										</div>
									</div>

									<div id="distance-info" style="display: none; margin-bottom: 20px; padding: 15px 20px; background: #fff8f8; border-radius: 15px; border-left: 4px solid #e7252d;">
										<p class="small mb-0" style="color: #e7252d; font-weight: 700; line-height: 1.4;">
											<i class="fas fa-map-marked-alt mr-2"></i> Confirm Your Pinpoint
											<span id="distance-note" style="display: block; font-weight: 400; color: #666; margin-top: 5px; font-size: 0.8rem;">We deliver for free within 1km. Beyond that, KES 100/km applies.</span>
										</p>
									</div>

									<div id="locationMap"></div>
									<input type="hidden" id="lat">
									<input type="hidden" id="lng">
									<input type="hidden" id="delivery_fee_hidden" value="0">
									
									<small id="drag-instructions" style="color: #666; font-weight: 600; margin-top: 10px; display: none; font-size: 0.75rem;">
										<i class="fas fa-info-circle mr-1"></i> Drag the marker to your exact gate or door.
									</small>
								</div>

								<div class="col-12 mt-3">
									<div class="input-group-pcnc">
										<label>Note to Rider (Optional)</label>
										<textarea id="order-notes" placeholder="e.g. Leave at the gate, call when arrived..." style="height: 80px;"></textarea>
									</div>
								</div>
							</div>
						</div>

						<!-- Section 2: Payment -->
						<div class="checkout-card">
							<h4 class="checkout-step-title">
								<span class="checkout-step-number">2</span>
								Payment Method
							</h4>
							
							<div class="payment-grid">
								<label class="pm-card" id="label-stk" onclick="selectPayment('stk')">
									<input type="radio" name="payment_method" value="stk" checked style="display: none;">
									<div class="check-icon" style="position: absolute; top: 15px; right: 15px; color: #e7252d; display: none;"><i class="fas fa-check-circle"></i></div>
									<i class="fas fa-bolt" style="color: #43B02A;"></i>
									<h6 style="font-weight: 800; margin-bottom: 5px;">M-Pesa Express</h6>
									<p style="font-size: 0.75rem; color: #777; margin: 0; line-height: 1.4;">Automatic prompt to your phone.</p>
								</label>

								<label class="pm-card" id="label-till" onclick="selectPayment('till')">
									<input type="radio" name="payment_method" value="till" style="display: none;">
									<div class="check-icon" style="position: absolute; top: 15px; right: 15px; color: #e7252d; display: none;"><i class="fas fa-check-circle"></i></div>
									<i class="fas fa-store-alt" style="color: #43B02A;"></i>
									<h6 style="font-weight: 800; margin-bottom: 5px;">Buy Goods Till</h6>
									<p style="font-size: 0.75rem; color: #777; margin: 0; line-height: 1.4;">Manual pay to merchant till.</p>
								</label>
							</div>
							
							<!-- ENHANCED TILL INSTRUCTIONS -->
							<div id="till-instructions" style="display: none; margin-top: 25px; background: #fdfdfd; border: 2px solid #43B02A; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 30px rgba(67, 176, 42, 0.08);">
								<div style="background: #43B02A; padding: 15px 25px; color: #fff; display: flex; align-items: center; gap: 12px;">
									<i class="fas fa-info-circle" style="font-size: 1.2rem;"></i>
									<span style="font-weight: 800; text-transform: uppercase; letter-spacing: 1px; font-size: 0.85rem;">Follow these steps to pay manually</span>
								</div>
								<div style="padding: 25px;">
									<div style="display: flex; flex-direction: column; gap: 15px;">
										<div style="display: flex; align-items: center; gap: 15px;">
											<div style="width: 28px; height: 28px; background: #e8f5e9; color: #43B02A; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 0.8rem; flex-shrink: 0;">1</div>
											<p style="margin: 0; font-weight: 700; color: #444; font-size: 0.9rem;">Go to Lipa na M-Pesa > <span style="color: #43B02A;">Buy Goods</span></p>
										</div>
										<div style="display: flex; align-items: center; gap: 15px;">
											<div style="width: 28px; height: 28px; background: #e8f5e9; color: #43B02A; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 0.8rem; flex-shrink: 0;">2</div>
											<p style="margin: 0; font-weight: 700; color: #444; font-size: 0.9rem;">Till Number: <strong style="font-size: 1.2rem; color: #1a1a1a; letter-spacing: 1px; background: #f4f4f4; padding: 2px 10px; border-radius: 6px; margin-left: 5px;">0715430320</strong></p>
										</div>
										<div style="display: flex; align-items: center; gap: 15px;">
											<div style="width: 28px; height: 28px; background: #e8f5e9; color: #43B02A; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 0.8rem; flex-shrink: 0;">3</div>
											<p style="margin: 0; font-weight: 700; color: #444; font-size: 0.9rem;">Enter amount shown in summary below</p>
										</div>
									</div>
									<div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; display: flex; align-items: center; gap: 10px;">
                                        <i class="fas fa-check-circle" style="color: #43B02A;"></i>
                                        <span style="font-size: 0.8rem; color: #888; font-weight: 600;">You'll enter the M-Pesa code on the tracking page.</span>
                                    </div>
								</div>
							</div>
						</div>
							
						<!-- Step 3: Order Summary -->
						<div class="checkout-card">
							<h4 class="checkout-step-title">
								<span class="checkout-step-number">3</span>
								Order Summary
							</h4>
							
							<div class="summary-box">
								<table class="summary-table">
									<tbody id="cart-table-body">
										<!-- Populated by JS -->
									</tbody>
								</table>

								<div class="promo-section mb-4 p-3" style="background: #fdfdfd; border-radius: 16px; border: 2px dashed #eee;">
									<label style="font-size: 0.7rem; font-weight: 800; color: #999; text-transform: uppercase; margin-bottom: 10px; display: block;">Apply Promo Code</label>
									<div style="display: flex; gap: 8px;">
										<input type="text" id="promoCodeInput" placeholder="Enter code" style="flex: 1; padding: 12px 20px; border: 2px solid #f4f4f4; border-radius: 12px; font-weight: 700; text-transform: uppercase; outline: none;">
										<button type="button" onclick="applyPromoCode()" style="background: #1a1a1a; color: #fff; border: none; padding: 0 20px; border-radius: 12px; font-weight: 700; cursor: pointer;">Apply</button>
									</div>
									<div id="promo-msg" class="small mt-2 font-weight-bold" style="display: none;"></div>
								</div>

								<div style="margin-top: 20px; padding: 25px; background: #fdfdfd; border-radius: 20px;">
									<div id="discount-row" style="display: none; justify-content: space-between; margin-bottom: 12px;">
										<span style="font-weight: 600; color: #116940;">Discount Applied</span>
										<span id="discount-amount" style="font-weight: 700; color: #116940;">-KES 0</span>
									</div>
									<div id="delivery-row" style="display: none; justify-content: space-between; margin-bottom: 12px;">
										<span style="font-weight: 600; color: #777;">Delivery Fee</span>
										<span id="delivery-fee-display" style="font-weight: 700; color: #333;">KES 0</span>
									</div>
									<div style="display: flex; justify-content: space-between; align-items: center; border-top: 2px solid #f4f4f4; margin-top: 15px; padding-top: 15px;">
										<span style="font-weight: 800; font-size: 1.1rem; color: #1a1a1a;">Total Amount</span>
										<span id="cart-total" style="font-weight: 900; font-size: 1.8rem; color: #c11b17;">KES 0</span>
									</div>
								</div>

								<div class="row mt-5 mb-4 text-center">
									<div class="col-4">
										<div style="background: rgba(67, 176, 42, 0.1); width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px;">
											<i class="fas fa-shield-alt" style="color: #43B02A; font-size: 1.2rem;"></i>
										</div>
										<span style="font-size: 0.65rem; font-weight: 800; color: #999; text-transform: uppercase;">Secure</span>
									</div>
									<div class="col-4">
										<div style="background: rgba(231, 37, 45, 0.1); width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px;">
											<i class="fas fa-fire-alt" style="color: #e7252d; font-size: 1.2rem;"></i>
										</div>
										<span style="font-size: 0.65rem; font-weight: 800; color: #999; text-transform: uppercase;">Served Hot</span>
									</div>
									<div class="col-4">
										<div style="background: rgba(52, 152, 219, 0.1); width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px;">
											<i class="fas fa-shipping-fast" style="color: #3498db; font-size: 1.2rem;"></i>
										</div>
										<span style="font-size: 0.65rem; font-weight: 800; color: #999; text-transform: uppercase;">Express</span>
									</div>
								</div>

								<div style="text-align: center;">
									<p id="stk-notice" style="font-size: 0.8rem; color: #43B02A; margin-bottom: 15px; font-weight: 700; background: #f0faf4; display: inline-block; padding: 8px 20px; border-radius: 50px;">
										<i class="fas fa-magic mr-1"></i> M-Pesa prompt will be sent to your phone.
									</p>
									<button type="submit" id="placeOrderBtn" class="boxed-btn" style="width: 100%; padding: 20px; background: #c11b17; border: none; font-weight: 800; font-size: 1.2rem; border-radius: 18px; transition: 0.3s; box-shadow: 0 10px 25px rgba(193, 27, 23, 0.2);">Place Order & Pay Now</button>
								</div>
							</div>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>

	<script>
		function selectPayment(type) {
			document.querySelectorAll('.pm-card').forEach(c => c.classList.remove('active'));
			document.querySelectorAll('.check-icon').forEach(i => i.style.display = 'none');
			
			const active = document.getElementById('label-' + type);
			active.classList.add('active');
			active.querySelector('.check-icon').style.display = 'block';
			
			const stkNotice = document.getElementById('stk-notice');
			const tillInstructions = document.getElementById('till-instructions');

			if(type === 'stk') {
				if(tillInstructions) tillInstructions.style.display = 'none';
				if(stkNotice) stkNotice.style.display = 'inline-block';
			} else {
				if(tillInstructions) tillInstructions.style.display = 'block';
				if(stkNotice) stkNotice.style.display = 'none';
			}
		}
		// Set default
		setTimeout(() => selectPayment('stk'), 200);
	</script>

				</div>
			</div>
		</div>
	</div>
	<!-- end check out section -->


		<!-- footer -->
	<div class="footer-area">
		<div class="container">
			<div class="row">
				<div class="col-lg-3 col-md-6">
					<div class="footer-box about-widget">
						<h2 class="widget-title">About us</h2>
						<p>Kibby’s Hot Kitchen is your destination for delicious, fresh, and healthy meals. Located at Unicity Mall (KU), we serve the best flavors in town.</p>
					</div>
				</div>
				<div class="col-lg-3 col-md-6">
					<div class="footer-box get-in-touch">
						<h2 class="widget-title">Get in Touch</h2>
						<ul>
							<li>Unicity Mall (KU)</li>
							<li>0715430320</li>
							<li>Till Number: 0715430320</li>
							<li>@kibbyshotkitchen</li>
						</ul>
					</div>
				</div>
                <div class="col-lg-3 col-md-6">
					<div class="footer-box">
						<h2 class="widget-title">Our Location</h2>
						<iframe 
                            src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3988.9443586071853!2d36.8837013!3d-1.2061226!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x182f3d97fa602737%3A0xc3f8e65893a7e44a!2sPizza%20Chick%20n%20Crust!5e0!3m2!1sen!2ske!4v1700000000000!5m2!1sen!2ske" 
                            width="100%" height="150" style="border:0; border-radius: 15px;" allowfullscreen="" loading="lazy">
                        </iframe>
					</div>
				</div>
				<div class="col-lg-3 col-md-6">
					<div class="footer-box pages">
						<h2 class="widget-title">Pages</h2>
						<ul>
							<li><a href="index.html">Home</a></li>
							<li><a href="about.html">About</a></li>
							<li><a href="contact.html">Contact</a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- end footer -->
	
	<!-- copyright -->
	<div class="copyright">
		<div class="container">
			<div class="row">
				<div class="col-lg-6 col-md-12">
					<p>Copyrights &copy; 2026 - Kibby's Hot Kitchen,  All Rights Reserved.</p>
				</div>
				<div class="col-lg-6 text-right col-md-12">
					<div class="social-icons">
						<ul>
							<li><a href="#" target="_blank"><i class="fab fa-facebook-f"></i></a></li>
							<li><a href="https://www.tiktok.com/@pizzachickncrust" target="_blank"><i class="fab fa-tiktok"></i></a></li>
							<li><a href="https://www.instagram.com/pizzachickncrust" target="_blank"><i class="fab fa-instagram"></i></a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- end copyright -->
	
	<!-- jquery -->
	<script src="assets/js/jquery-1.11.3.min.js"></script>
	<!-- bootstrap -->
	<script src="assets/bootstrap/js/bootstrap.min.js"></script>
	<!-- count down -->
	<script src="assets/js/jquery.countdown.js"></script>
	<!-- isotope -->
	<script src="assets/js/jquery.isotope-3.0.6.min.js"></script>
	<!-- waypoints -->
	<script src="assets/js/waypoints.js"></script>
	<!-- owl carousel -->
	<script src="assets/js/owl.carousel.min.js"></script>
	<!-- magnific popup -->
	<script src="assets/js/jquery.magnific-popup.min.js"></script>
	<!-- mean menu -->
	<script src="assets/js/jquery.meanmenu.min.js"></script>
	<!-- sticker js -->
	<script src="assets/js/sticker.js"></script>
	<!-- main js -->
	<script src="assets/js/main.js"></script>
    <script src="assets/js/pcnc.js?v=1.2"></script>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, marker, searchTimeout;
        let usiuPos = [-1.2200414264779664, 36.87814128003106]; // Default Restaurant Coordinates

        // Fetch settings for dynamic restaurant location
        async function loadRestaurantPos() {
            try {
                const res = await fetch('/api/settings');
                const data = await res.json();
                if (data.restaurantLat && data.restaurantLng) {
                    usiuPos = [data.restaurantLat, data.restaurantLng];
                }
            } catch (e) { console.error("Could not load dynamic settings", e); }
        }
        loadRestaurantPos();

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // km
            const dLat = (lat2-lat1) * Math.PI / 180;
            const dLon = (lon2-lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function updateDeliveryFee(lat, lng) {
            const dist = calculateDistance(usiuPos[0], usiuPos[1], lat, lng);
            
            // Logic: Within 1km = FREE. Beyond 1km = 100 per km.
            let fee = 0;
            if (dist > 1.0) {
                fee = Math.round(dist * 100);
                
                // Reveal map and info ONLY for paid delivery
                $('#distance-info').fadeIn();
                $('#locationMap').fadeIn();
                $('#drag-instructions').fadeIn();
                initCheckoutMap();
            } else {
                // Hide if within free zone
                $('#distance-info').fadeOut();
                $('#locationMap').fadeOut();
                $('#drag-instructions').fadeOut();
            }
            
            $('#delivery_fee_hidden').val(fee);
            if (fee > 0) {
                $('#delivery-fee-display').text(`KES ${fee}`);
                $('#delivery-row').css('display', 'flex');
                if ($('#distance-note').length) {
                    $('#distance-note').html(`Distance: <strong>${dist.toFixed(2)}km</strong>. Delivery fee <strong>KES ${fee}</strong> applied.`);
                }
            } else {
                $('#delivery-row').hide();
            }
            renderCartPage();
        }

        function initCheckoutMap() {
            if (map) return;
            const defaultPos = usiuPos;
            map = L.map('locationMap').setView(defaultPos, 16);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            marker = L.marker(defaultPos, { draggable: true, icon: L.icon({
                iconUrl: 'https://cdn0.iconfinder.com/data/icons/small-n-flat/24/678111-map-marker-512.png',
                iconSize: [40, 40],
                iconAnchor: [20, 40]
            }) }).addTo(map);

            marker.on('dragend', function() {
                const pos = marker.getLatLng();
                document.getElementById('lat').value = pos.lat;
                document.getElementById('lng').value = pos.lng;
                updateDeliveryFee(pos.lat, pos.lng);
            });
            
            // Initial coords
            document.getElementById('lat').value = defaultPos[0];
            document.getElementById('lng').value = defaultPos[1];
        }

        function locateMe() {
            if (!navigator.geolocation) {
                if(typeof showNotification === 'function') showNotification('Error', 'Geolocation not supported by your browser.', 'error');
                return;
            }

            if(typeof showNotification === 'function') showNotification('Locating...', 'Please allow location access to pinpoint your house.', 'info');
            
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    
                    initCheckoutMap();
                    map.setView([lat, lng], 18);
                    marker.setLatLng([lat, lng]);
                    document.getElementById('lat').value = lat;
                    document.getElementById('lng').value = lng;
                    updateDeliveryFee(lat, lng);
                    
                    fetch(`https://photon.komoot.io/reverse?lon=${lng}&lat=${lat}`)
                        .then(r => r.json())
                        .then(data => {
                            if (data.features && data.features.length > 0) {
                                const feat = data.features[0].properties;
                                const name = [feat.name, feat.street, feat.city].filter(Boolean).join(', ');
                                document.getElementById('address').value = name;
                                if(typeof showNotification === 'function') showNotification('Located!', 'We found your area: ' + (feat.name || 'Current Position'), 'success');
                            }
                        });
                },
                (err) => {
                    if(typeof showNotification === 'function') showNotification('Location Denied', 'Couldn\'t get your GPS position. Please search manually.', 'error');
                }
            );
        }

        function selectLocation(lat, lng, label) {
            document.getElementById('address').value = label;
            document.getElementById('lat').value = lat;
            document.getElementById('lng').value = lng;
            $('#location-suggestions').hide();
            
            // Map updates and confirmation
            initCheckoutMap();
            map.setView([lat, lng], 17);
            marker.setLatLng([lat, lng]);

            // Always calculate fee based on distance
            updateDeliveryFee(lat, lng);
        }
    </script>

	<!-- Mobile Bottom Nav -->
	<div class="mobile-bottom-nav">
		<a href="index.html" class="nav-item">
			<i class="fas fa-home"></i>
			<span>Home</span>
		</a>
		<a href="shop.html" class="nav-item">
			<i class="fas fa-utensils"></i>
			<span>Menu</span>
		</a>
		<a href="cart.html" class="nav-item">
			<i class="fas fa-shopping-cart"></i>
			<span class="cart-count">0</span>
			<span>Cart</span>
		</a>
		<a href="track-order.html" class="nav-item">
			<i class="fas fa-truck"></i>
			<span>Track</span>
		</a>
	</div>

</body>
</html>

