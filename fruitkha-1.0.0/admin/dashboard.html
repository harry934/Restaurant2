<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard | Kibby's Hot Kitchen</title>
    <link rel="stylesheet" href="../assets/bootstrap/css/bootstrap.min.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
      * {
        box-sizing: border-box !important;
      }
      :root {
        --sidebar-width: 280px;
        --kibbys-red: #c11b17;
      }
      body {
        font-family: "Inter", sans-serif;
        background-color: #f4f6f9;
        color: #333;
        margin: 0;
        padding: 0;
      }

      .sidebar {
        height: 100vh;
        background: #1a1a1a;
        color: #fff;
        position: fixed;
        width: var(--sidebar-width);
        padding: 25px;
        box-shadow: 4px 0 10px rgba(0, 0, 0, 0.4);
        z-index: 1000;
        transition: transform 0.3s ease;
      }
      .sidebar h4 {
        font-weight: 800;
        font-size: 1.2rem;
        margin-bottom: 30px;
        color: #fff;
        letter-spacing: 1px;
      }
      .sidebar h4 span {
        color: var(--kibbys-red);
      }
      .sidebar a {
        color: #999;
        display: flex;
        align-items: center;
        padding: 14px 18px;
        text-decoration: none;
        border-radius: 12px;
        margin-bottom: 8px;
        font-weight: 600;
        transition: 0.3s;
        cursor: pointer;
      }
      .sidebar a i {
        margin-right: 15px;
        font-size: 1.1rem;
      }
      .sidebar a:hover,
      .sidebar a.active {
        color: white;
        background: rgba(193, 27, 23, 0.15);
        color: var(--kibbys-red);
      }
      .sidebar a.logout {
        color: #888;
        margin-top: 10px;
        font-weight: 500;
        font-size: 0.85rem;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 0;
      }
      .sidebar a.logout:hover {
        color: #fff;
        background: transparent;
      }

      .main-content {
        margin-left: var(--sidebar-width) !important;
        padding: 50px !important;
        transition: margin-left 0.3s ease;
        min-height: 100vh;
        position: relative;
        z-index: 1;
      }
      .header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 45px;
        gap: 25px;
        flex-wrap: wrap;
      }
      .stat-card {
        background: #fff;
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.03);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        height: 100%;
      }
      .stat-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 15px 45px rgba(0, 0, 0, 0.08);
      }

      .order-card {
        background: #fff;
        border-radius: 24px;
        border: none;
        box-shadow: 0 15px 50px rgba(0, 0, 0, 0.04);
        overflow: hidden;
        margin-top: 20px;
      }
      .table thead th {
        background: #fafafa;
        border: none;
        padding: 18px;
        font-size: 0.7rem;
        text-transform: uppercase;
        color: #888;
        font-weight: 800;
      }
      .table td {
        padding: 18px;
        border-top: 1px solid #f8f8f8;
        vertical-align: middle;
      }

      .status-badge {
        padding: 6px 12px;
        border-radius: 50px;
        font-weight: 800;
        font-size: 0.65rem;
        text-transform: uppercase;
      }
      .bg-new {
        background: rgba(0, 123, 255, 0.1);
        color: #007bff;
      }
      .bg-preparing {
        background: rgba(255, 193, 7, 0.15);
        color: #b88b00;
      }
      .bg-shipping {
        background: rgba(23, 162, 184, 0.1);
        color: #17a2b8;
      }
      .bg-completed {
        background: rgba(40, 167, 69, 0.1);
        color: #28a745;
      }

      .btn-action {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        border: none;
        transition: 0.2s;
        margin-right: 5px;
        cursor: pointer;
      }
      .btn-edit {
        background: #6c757d11;
        color: #6c757d;
      }
      .btn-delete {
        background: #dc354511;
        color: #dc3545;
      }
      .btn-prep {
        background: #ffc10722;
        color: #b88b00;
      }
      .btn-ship {
        background: #17a2b822;
        color: #17a2b8;
      }
      .btn-done {
        background: #28a74522;
        color: #28a745;
      }

      .view-section {
        display: none;
      }
      .view-section.active {
        display: block !important;
        animation: fadeInSoft 0.4s ease-out;
      }

      @keyframes fadeInSoft {
        from {
          opacity: 0;
          transform: translateY(5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Distinctive row coloring based on status */
      tr.row-new {
        background-color: rgba(0, 123, 255, 0.04) !important;
        border-left: 4px solid #007bff;
      }
      tr.row-preparing {
        background-color: rgba(255, 193, 7, 0.04) !important;
        border-left: 4px solid #ffc107;
      }
      tr.row-shipping {
        background-color: rgba(23, 162, 184, 0.04) !important;
        border-left: 4px solid #17a2b8;
      }
      tr.row-completed {
        background-color: rgba(40, 167, 69, 0.03) !important;
        border-left: 4px solid #28a745;
        opacity: 0.8;
      }

      tr.row-completed .customer-info div {
        color: #888;
      }
      tr.row-completed .btn-prep,
      tr.row-completed .btn-ship,
      tr.row-completed .btn-done {
        display: none;
      }

      /* Mobile Menu Toggle Button */
      .mobile-menu-toggle {
        display: none;
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1001;
        background: var(--kibbys-red);
        color: #fff;
        border: none;
        border-radius: 12px;
        padding: 12px 15px;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(193, 27, 23, 0.3);
        transition: all 0.3s ease;
      }

      .mobile-menu-toggle:hover {
        background: #c71f27;
        transform: scale(1.05);
      }

      .mobile-menu-toggle i {
        font-size: 20px;
      }

      /* Mobile Overlay */
      .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .sidebar-overlay.active {
        opacity: 1;
      }

      /* Mobile Responsive Styles */
      @media only screen and (max-width: 991px) {
        .mobile-menu-toggle {
          display: block;
        }

        .sidebar {
          transform: translateX(-100%);
          width: 280px;
        }

        .sidebar.active {
          transform: translateX(0);
        }

        .sidebar-overlay {
          display: block;
        }

        .main-content {
          margin-left: 0;
          padding: 100px 20px 40px 20px;
        }

        .header-top {
          flex-direction: column;
          align-items: flex-start;
          gap: 15px;
        }

        .header-top .d-flex {
          width: 100%;
          justify-content: flex-start;
          flex-wrap: wrap;
          gap: 10px;
        }

        .header-top button {
          font-size: 13px;
          padding: 10px 15px !important;
        }

        /* Stats cards mobile */
        .stat-card {
          padding: 20px;
          margin-bottom: 15px;
        }

        /* Table mobile optimization */
        .table-responsive {
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
        }

        .table {
          min-width: 800px;
        }

        .table thead th {
          font-size: 0.65rem;
          padding: 12px 8px;
        }

        .table td {
          padding: 12px 8px;
          font-size: 0.85rem;
        }

        /* Settings tabs mobile */
        .settings-nav-btn {
          font-size: 13px !important;
          padding: 10px 15px !important;
          margin-bottom: 10px;
        }

        /* Modal adjustments */
        .modal-dialog {
          margin: 10px;
        }

        .modal-body {
          padding: 20px !important;
        }

        /* Form adjustments */
        .form-group label {
          font-size: 14px;
        }

        .form-control {
          font-size: 14px;
        }

        /* Button groups */
        .btn-action {
          width: 28px;
          height: 28px;
          font-size: 0.7rem;
        }

        /* Hide some columns on very small screens */
        @media only screen and (max-width: 575px) {
          .table {
            font-size: 12px;
          }

          h2 {
            font-size: 1.5rem !important;
          }

          h5 {
            font-size: 1.1rem !important;
          }
        }
      }

      /* Tablet landscape and small desktop */
      @media only screen and (min-width: 992px) and (max-width: 1366px) {
        :root {
          --sidebar-width: 260px;
        }
        .main-content {
          padding: 30px !important;
          margin-left: 260px !important;
        }
      }

      @media only screen and (min-width: 768px) and (max-width: 991px) {
        .main-content {
          margin-left: 0;
          padding: 100px 20px 40px 20px;
        }
        .sidebar {
          transform: translateX(-100%);
          width: 280px;
        }
      }

      /* Profile Specific Styles */
      .profile-header-card {
        background: linear-gradient(
          135deg,
          #1a1a1a 0%,
          #2a2a2a 100%
        ) !important;
        color: #ffffff !important;
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4) !important;
        position: relative;
        overflow: hidden;
        z-index: 1;
      }
      .profile-header-card::before {
        content: "";
        position: absolute;
        top: -50%;
        right: -20%;
        width: 300px;
        height: 300px;
        background: rgba(193, 27, 23, 0.1);
        border-radius: 50%;
        z-index: -1;
        filter: blur(50px);
      }
      .profile-form-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(0, 0, 0, 0.05);
      }
      .profile-input-group {
        background: #f8f9fa;
        border-radius: 12px;
        border: 1px solid #eee;
        transition: 0.3s;
      }
      .profile-input-group:focus-within {
        background: #fff;
        border-color: var(--kibbys-red);
        box-shadow: 0 0 0 4px rgba(193, 27, 23, 0.05);
      }
      .profile-input-group .form-control {
        background: transparent;
        border: none;
      }
      .profile-input-group .form-control:focus {
        box-shadow: none;
      }

      /* Fix for potential overlapping */
      .view-section {
        padding-bottom: 50px;
      }
    </style>
  </head>
  <body>
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
      <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" onclick="toggleMobileMenu()"></div>

    <div class="sidebar d-flex flex-column" style="overflow-y: auto">
      <h4>Kibby's Hot Kitchen <span>HQ</span></h4>

      <!-- Welcome Section -->
      <div
        id="adminNameDisplay"
        style="
          background: rgba(235, 33, 41, 0.08);
          padding: 15px;
          border-radius: 16px;
          margin-bottom: 20px;
          display: none;
          border: 1px solid rgba(235, 33, 41, 0.12);
          box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        "
      >
        <div class="d-flex align-items-center">
          <div class="position-relative">
            <img
              id="adminProfilePhoto"
              src="../assets/img/products/default-avatar.png"
              style="
                width: 42px;
                height: 42px;
                border-radius: 50%;
                object-fit: cover;
                border: 2px solid var(--kibbys-red);
                background: white;
              "
            />
            <span
              style="
                position: absolute;
                bottom: 2px;
                right: 2px;
                width: 10px;
                height: 10px;
                background: #28a745;
                border: 2px solid #1a1a1a;
                border-radius: 50%;
              "
            ></span>
          </div>
          <div class="ml-3" style="overflow: hidden">
            <div
              style="
                font-size: 0.6rem;
                text-transform: uppercase;
                color: var(--kibbys-red);
                font-weight: 800;
                letter-spacing: 1px;
                margin-bottom: 0px;
                white-space: nowrap;
              "
            >
              Staff Identity
            </div>
            <div
              id="adminNameText"
              style="
                color: #fff;
                font-weight: 800;
                font-size: 0.95rem;
                line-height: 1.2;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
              "
            ></div>
          </div>
        </div>
      </div>

      <!-- Active Staff Status (Authorized Admins Only) -->
      <div
        id="activeSessionsDisplay"
        style="
          background: rgba(255, 255, 255, 0.03);
          padding: 15px;
          border-radius: 16px;
          margin-bottom: 25px;
          border: 1px solid rgba(255, 255, 255, 0.05);
        "
      >
        <div
          style="
            font-size: 0.65rem;
            text-transform: uppercase;
            color: #666;
            font-weight: 700;
            letter-spacing: 1px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
          "
        >
          <i
            class="fas fa-shield-alt"
            style="margin-right: 8px; color: #28a745"
          ></i>
          Authorized Access
        </div>
        <div
          id="activeSessionsList"
          style="max-height: 150px; overflow-y: auto"
        >
          <!-- Will be populated with Online/Offline status -->
        </div>
      </div>

      <nav id="sidebarNav" class="flex-grow-1">
        <a
          onclick="switchView('dashboard')"
          class="active"
          data-view="dashboard"
          ><i class="fas fa-home"></i> Command Center</a
        >
        <a
          onclick="switchView('profile')"
          data-view="profile"
          id="profileNavLink"
          style="display: none"
          ><i class="fas fa-user-circle"></i> My Profile</a
        >
        <!-- Restricted Views -->
        <div id="restrictedNav" style="display: none">
          <a onclick="switchView('active')" data-view="active"
            ><i class="fas fa-clock"></i> Active Orders</a
          >
          <a onclick="switchView('analytics')" data-view="analytics"
            ><i class="fas fa-chart-bar"></i> Sales Analytics</a
          >
          <a onclick="switchView('history')" data-view="history"
            ><i class="fas fa-history"></i> Order History</a
          >
          <a onclick="switchView('menu')" data-view="menu"
            ><i class="fas fa-utensils"></i> Menu Items</a
          >
          <a onclick="switchView('staff')" data-view="staff"
            ><i class="fas fa-users-cog"></i> Staff Applications</a
          >
          <a onclick="switchView('settings')" data-view="settings"
            ><i class="fas fa-cog"></i> System Settings</a
          >
        </div>
      </nav>

      <div class="mt-auto pt-3">
        <a onclick="logout()" class="logout">
          <i class="fas fa-power-off"></i> Sign Out of System
        </a>
      </div>
    </div>

    <div class="main-content">
      <!-- Dashboard / Orders View -->
      <div id="orders-section" class="view-section active">
        <div class="header-top">
          <div>
            <h2 id="viewTitle">Live Operations</h2>
            <p class="text-muted small mb-0" id="viewSubtitle">
              Real-time order tracking & kitchen management
            </p>
          </div>
          <div
            id="realtimeClock"
            style="
              background: linear-gradient(135deg, var(--kibbys-red) 0%, #a11612 100%);
              padding: 15px 25px;
              border-radius: 16px;
              box-shadow: 0 8px 20px rgba(193, 27, 23, 0.25);
              text-align: center;
              min-width: 200px;
            "
          >
            <div
              style="
                font-size: 0.65rem;
                text-transform: uppercase;
                color: rgba(255, 255, 255, 0.8);
                font-weight: 600;
                letter-spacing: 1.5px;
                margin-bottom: 4px;
              "
            >
              Current Time
            </div>
            <div
              id="clockTime"
              style="
                font-size: 1.8rem;
                font-weight: 800;
                color: white;
                font-family: 'Inter', monospace;
                letter-spacing: 1px;
              "
            >
              --:--:--
            </div>
            <div
              id="clockDate"
              style="
                font-size: 0.7rem;
                color: rgba(255, 255, 255, 0.9);
                font-weight: 600;
                margin-top: 2px;
              "
            >
              Loading...
            </div>
          </div>
          <div class="d-flex align-items-center" style="gap: 12px;">
            <div
              class="custom-control custom-switch"
              id="viewerModeWrapper"
              style="
                display: none;
                background: #f8f9fa;
                padding: 10px 18px;
                border-radius: 12px;
                border: 1px solid #eee;
              "
            >
              <input
                type="checkbox"
                class="custom-control-input"
                id="managementModeToggle"
                onchange="toggleManagementMode()"
              />
              <label
                class="custom-control-label font-weight-bold text-muted"
                for="managementModeToggle"
                style="font-size: 0.8rem; cursor: pointer"
                >MANAGEMENT MODE</label
              >
            </div>
            <button
              class="btn btn-outline-success shadow-sm"
              style="border-radius: 12px; white-space: nowrap"
              onclick="downloadReport()"
            >
              <i class="fas fa-file-excel mr-2"></i> Daily Report
            </button>
            <button
              class="btn btn-dark shadow-sm"
              style="border-radius: 12px"
              onclick="handleRefresh()"
            >
              <i class="fas fa-sync-alt mr-2"></i> Refresh
            </button>
          </div>
        </div>

        <div class="row mb-5" id="statsRow">
          <!-- Stats populated via JS -->
        </div>

        <div class="card order-card">
          <div class="table-responsive">
            <table class="table mb-0">
              <thead>
                <tr>
                  <th>Ref Code</th>
                  <th>Customer & Location</th>
                  <th>Order Details</th>
                  <th>Total</th>
                  <th>Time</th>
                  <th>Payment</th>
                  <th>Processing</th>
                  <th class="text-center">Kitchen Actions</th>
                </tr>
              </thead>
              <tbody id="ordersTable"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Analytics View -->
      <div id="analytics-section" class="view-section">
        <div class="header-top">
          <div>
            <h2>Performance Analytics</h2>
            <p class="text-muted small mb-0">
              Track revenue trends and business growth
            </p>
          </div>
          <div>
            <button
              class="btn btn-dark shadow-sm"
              style="border-radius: 12px"
              onclick="handleRefresh()"
            >
              <i class="fas fa-sync-alt mr-2"></i> Refresh Data
            </button>
          </div>
        </div>

        <div class="row mb-5" id="analyticsRow">
          <div class="col-12">
            <div
              class="card order-card p-4 border-0 shadow-sm"
              style="border-radius: 20px"
            >
              <h5 class="font-weight-bold mb-4">
                <i class="fas fa-chart-line mr-2 text-danger"></i>7-Day Sales
                Performance
              </h5>
              <div style="height: 400px">
                <canvas id="salesChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div
              class="card order-card p-4 border-0 shadow-sm"
              style="border-radius: 20px"
            >
              <h5 class="font-weight-bold mb-3">Top Selling Categories</h5>
              <div style="height: 250px">
                <canvas id="categoryChart"></canvas>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div
              class="card order-card p-4 border-0 shadow-sm"
              style="border-radius: 20px"
            >
              <h5 class="font-weight-bold mb-3">
                Customer Growth (New vs Returning)
              </h5>
              <div style="height: 250px">
                <canvas id="customerChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Menu Management View -->
      <div id="menu-section" class="view-section">
        <div class="header-top align-items-end">
          <div>
            <h2>Menu Management</h2>
            <p class="text-muted small mb-0">
              Add or remove items from the live menu
            </p>
            <div class="mt-3">
              <div class="input-group" style="width: 300px">
                <div class="input-group-prepend">
                  <span
                    class="input-group-text bg-white border-right-0"
                    style="border-radius: 12px 0 0 12px"
                    ><i class="fas fa-search text-muted"></i
                  ></span>
                </div>
                <input
                  type="text"
                  id="menuSearch"
                  class="form-control border-left-0"
                  placeholder="Search menu..."
                  style="border-radius: 0 12px 12px 0"
                  onkeyup="loadMenu()"
                />
              </div>
            </div>
          </div>
          <button
            class="btn btn-primary shadow-sm"
            style="border-radius: 12px"
            onclick="$('#addMenuModal').modal('show')"
          >
            <i class="fas fa-plus mr-2"></i> Add Item
          </button>
        </div>

        <div class="card order-card">
          <div class="table-responsive">
            <table class="table mb-0">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Image</th>
                  <th>Name</th>
                  <th>Category</th>
                  <th>Price</th>
                  <th class="text-center">Action</th>
                </tr>
              </thead>
              <tbody id="menuTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Staff Management View -->
      <div id="staff-section" class="view-section">
        <div class="header-top">
          <div>
            <h2>Staff Applications</h2>
            <p class="text-muted small mb-0">
              Approve or reject employee access requests
            </p>
          </div>
        </div>

        <div class="card order-card mt-4">
          <div class="table-responsive">
            <table class="table mb-0">
              <thead style="background: #fafafa">
                <tr>
                  <th>Staff Identification</th>
                  <th>Contact Information</th>
                  <th>Access Status</th>
                  <th>Applied Date</th>
                  <th class="text-right">Admin Actions</th>
                </tr>
              </thead>
              <tbody id="staffTable">
                <!-- Populated via JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- System Settings View -->
      <div id="settings-section" class="view-section">
        <div class="header-top mb-4">
          <div>
            <h2 class="font-weight-bold">Command Center Settings</h2>
            <p class="text-muted small mb-0">
              Manage website content, logistics, and support channels
            </p>
          </div>
        </div>

        <!-- Settings Navigation Buttons -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="d-flex flex-wrap gap-2" style="gap: 10px">
              <button
                class="btn btn-dark active px-4 py-2 settings-nav-btn"
                onclick="showSettingsTab('core', this)"
                style="border-radius: 10px; font-weight: 700"
              >
                <i class="fas fa-globe mr-2"></i> Website Core
              </button>
              <button
                class="btn btn-outline-dark px-4 py-2 settings-nav-btn"
                onclick="showSettingsTab('logistics', this)"
                style="border-radius: 10px; font-weight: 700"
              >
                <i class="fas fa-motorcycle mr-2"></i> Logistics & Riders
              </button>
              <button
                class="btn btn-outline-dark px-4 py-2 settings-nav-btn"
                onclick="showSettingsTab('marketing', this)"
                style="border-radius: 10px; font-weight: 700"
              >
                <i class="fas fa-ad mr-2"></i> Marketing & Deals
              </button>
              <button
                class="btn btn-outline-dark px-4 py-2 settings-nav-btn"
                onclick="showSettingsTab('team', this)"
                style="border-radius: 10px; font-weight: 700"
              >
                <i class="fas fa-users mr-2"></i> Internal Team
              </button>
              <button
                class="btn btn-outline-dark px-4 py-2 settings-nav-btn"
                onclick="showSettingsTab('categories', this)"
                style="border-radius: 10px; font-weight: 700"
              >
                <i class="fas fa-tags mr-2"></i> Menu Flavors
              </button>
            </div>
          </div>
        </div>

        <div class="row">
          <!-- CORE WEBSITE INFO -->
          <div class="col-lg-12 settings-tab-content" id="tab-core">
            <div
              class="card order-card p-4 border-0 shadow-sm"
              style="border-radius: 20px"
            >
              <h5 class="font-weight-bold mb-4">
                <i class="fas fa-info-circle text-primary mr-2"></i> Core
                Website Info & Hero
              </h5>
              <form id="settingsForm">
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label
                        class="small font-weight-bold d-flex justify-content-between align-items-center"
                      >
                        <span>Primary Support Phone Numbers</span>
                        <button
                          type="button"
                          class="btn btn-sm btn-primary"
                          onclick="addPhoneField()"
                        >
                          <i class="fas fa-plus"></i>
                        </button>
                      </label>
                      <div id="phoneFields"></div>
                    </div>
                    <div class="form-group">
                      <label
                        class="small font-weight-bold d-flex justify-content-between align-items-center"
                      >
                        <span>Support Emails</span>
                        <button
                          type="button"
                          class="btn btn-sm btn-primary"
                          onclick="addEmailField()"
                        >
                          <i class="fas fa-plus"></i>
                        </button>
                      </label>
                      <div id="emailFields"></div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <h6
                      class="font-weight-bold small text-uppercase text-danger mb-3"
                    >
                      Homepage Hero Section
                    </h6>
                    <div class="form-group">
                      <label class="small font-weight-bold">Main Title</label
                      ><input
                        type="text"
                        name="homeTitle"
                        class="form-control"
                        placeholder="e.g. Delicious Food Delivered"
                      />
                    </div>
                    <div class="form-group">
                      <label class="small font-weight-bold">Subtitle</label
                      ><input
                        type="text"
                        name="homeSubtext"
                        class="form-control"
                        placeholder="e.g. Freshly made with love"
                      />
                    </div>
                    <div class="form-group">
                      <label class="small font-weight-bold"
                        >About Main Description</label
                      ><textarea
                        name="aboutText"
                        class="form-control"
                        rows="3"
                      ></textarea>
                    </div>
                  </div>
                </div>
                <div class="text-right">
                  <button
                    type="submit"
                    class="btn btn-dark px-5 py-3"
                    style="border-radius: 12px; font-weight: 800"
                  >
                    SAVE CORE CHANGES
                  </button>
                </div>
              </form>

              <hr class="my-4" />
              <h6
                class="font-weight-bold small text-uppercase text-danger mb-3"
              >
                Homepage "About" Video Section
              </h6>
              <form id="homeAboutForm">
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label class="small font-weight-bold">Section Title</label
                      ><input
                        type="text"
                        name="title"
                        class="form-control"
                        placeholder="Since 2019"
                      />
                    </div>
                    <div class="form-group">
                      <label class="small font-weight-bold">Main Heading</label
                      ><input
                        type="text"
                        name="heading"
                        class="form-control"
                        placeholder="We are Pizza Chick n Crust"
                      />
                    </div>
                    <div class="form-group">
                      <label class="small font-weight-bold">Description</label
                      ><textarea
                        name="description"
                        class="form-control"
                        rows="3"
                      ></textarea>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label class="small font-weight-bold">Video Source</label>
                      <div class="custom-control custom-switch mb-2">
                        <input
                          type="checkbox"
                          class="custom-control-input"
                          id="isVideoLocal"
                          name="isVideoLocal"
                        />
                        <label class="custom-control-label" for="isVideoLocal"
                          >Use Uploaded Video</label
                        >
                      </div>
                      <input
                        type="text"
                        name="videoLink"
                        class="form-control mb-2"
                        placeholder="Youtube URL or file path"
                      />

                      <div class="custom-file">
                        <input
                          type="file"
                          class="custom-file-input"
                          id="videoUpload"
                          name="videoFile"
                          accept="video/mp4,video/webm"
                        />
                        <label class="custom-file-label" for="videoUpload"
                          >Upload Video File</label
                        >
                      </div>
                      <small class="text-muted"
                        >Uploads will auto-fill the path.</small
                      >
                    </div>
                    <div class="form-group">
                      <label class="small font-weight-bold"
                        >Background Image</label
                      >
                      <div class="custom-file">
                        <input
                          type="file"
                          class="custom-file-input"
                          id="homeAboutImageInput"
                          name="abtImage"
                        />
                        <label
                          class="custom-file-label"
                          for="homeAboutImageInput"
                          >Choose Image...</label
                        >
                      </div>
                    </div>
                  </div>
                </div>
                <div class="text-right mt-3">
                  <button
                    type="submit"
                    class="btn btn-danger px-5 py-2"
                    style="border-radius: 12px; font-weight: 800"
                  >
                    UPDATE ABOUT SECTION
                  </button>
                </div>
              </form>

              <hr class="my-4" />
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="font-weight-bold mb-1">System Reliability</h6>
                  <p class="small text-muted mb-0">
                    Create a secure snapshot of your orders, menu, and system
                    settings.
                  </p>
                </div>
                <button
                  class="btn btn-outline-info"
                  onclick="triggerBackup()"
                  style="border-radius: 10px; font-weight: 700"
                >
                  <i class="fas fa-database mr-2"></i> Create Manual Backup
                </button>
              </div>
            </div>
          </div>

          <!-- LOGISTICS & RIDERS -->
          <div class="col-lg-12 settings-tab-content d-none" id="tab-logistics">
            <div class="row">
              <div class="col-md-4">
                <div
                  class="card order-card p-4 border-0 shadow-sm h-100"
                  style="border-radius: 20px"
                >
                  <h5 class="font-weight-bold mb-3">Global Contact</h5>
                  <div class="form-group">
                    <label class="small font-weight-bold"
                      >Global WhatsApp Support</label
                    >
                    <input
                      type="text"
                      id="globalWhatsappInput"
                      class="form-control"
                      placeholder="07..."
                    />
                    <small class="text-muted"
                      >Used as fallback if no rider is assigned.</small
                    >
                  </div>
                  <button
                    class="btn btn-dark btn-block mt-2"
                    onclick="saveGlobalWhatsapp()"
                    style="border-radius: 10px"
                  >
                    SAVE CONTACT
                  </button>
                </div>
              </div>
              <div class="col-md-8">
                <div
                  class="card order-card p-4 border-0 shadow-sm"
                  style="border-radius: 20px"
                >
                  <div
                    class="d-flex justify-content-between align-items-center mb-4"
                  >
                    <h5 class="font-weight-bold mb-0">Active Dispatch Team</h5>
                    <button
                      class="btn btn-sm btn-success px-3"
                      onclick="$('#addRiderModal').modal('show')"
                    >
                      <i class="fas fa-plus mr-1"></i> Register New Rider
                    </button>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-borderless table-hover">
                      <thead class="text-muted small text-uppercase">
                        <tr>
                          <th>Photo</th>
                          <th>Name / Phone</th>
                          <th class="text-right">Manage</th>
                        </tr>
                      </thead>
                      <tbody id="riderTableBody"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- MARKETING & PROMOS -->
          <div class="col-lg-12 settings-tab-content d-none" id="tab-marketing">
            <div class="row mb-4">
              <div class="col-md-6">
                <div
                  class="card order-card p-4 h-100 border-0 shadow-sm"
                  style="border-radius: 20px"
                >
                  <h5 class="font-weight-bold mb-4">Deal of the Week</h5>
                  <form id="dealForm">
                    <div class="form-group">
                      <label class="small font-weight-bold">Section Title</label
                      ><input type="text" name="title" class="form-control" />
                    </div>
                    <div class="form-group">
                      <label class="small font-weight-bold">Headline</label
                      ><input
                        type="text"
                        name="subtitle"
                        class="form-control"
                      />
                    </div>
                    <div class="form-group">
                      <label class="small font-weight-bold">Description</label
                      ><textarea
                        name="description"
                        class="form-control"
                        rows="2"
                      ></textarea>
                    </div>
                    <div class="form-group">
                      <label class="small font-weight-bold"
                        >Image URL or Path</label
                      >
                      <input
                        type="text"
                        name="image"
                        class="form-control mb-2"
                        placeholder="assets/img/..."
                      />
                      <input
                        type="file"
                        id="dealImageInput"
                        class="form-control-file"
                      />
                    </div>
                    <button
                      type="submit"
                      class="btn btn-danger btn-block py-3 mt-2"
                      style="border-radius: 12px; font-weight: 700"
                    >
                      UPDATE PROMOTION
                    </button>
                  </form>
                </div>
              </div>
              <div class="col-md-6">
                <div
                  class="card order-card p-4 border-0 shadow-sm"
                  style="border-radius: 20px"
                >
                  <div
                    class="d-flex justify-content-between align-items-center mb-4"
                  >
                    <h5 class="font-weight-bold mb-0">Promo Codes</h5>
                    <button
                      class="btn btn-sm btn-primary"
                      onclick="$('#addPromoModal').modal('show')"
                      style="border-radius: 8px"
                    >
                      <i class="fas fa-plus mr-1"></i> Add Code
                    </button>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead>
                        <tr>
                          <th>Code</th>
                          <th>Discount</th>
                          <th class="text-right">Action</th>
                        </tr>
                      </thead>
                      <tbody id="promoTableBody"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- TEAM LIST -->
          <div class="col-lg-12 settings-tab-content d-none" id="tab-team">
            <div
              class="card order-card p-4 border-0 shadow-sm"
              style="border-radius: 20px"
            >
              <div
                class="d-flex justify-content-between align-items-center mb-4"
              >
                <h5 class="font-weight-bold mb-0">Our Dedicated Team</h5>
                <button
                  class="btn btn-sm btn-primary"
                  onclick="$('#addTeamModal').modal('show')"
                >
                  <i class="fas fa-user-plus mr-1"></i> Add Member
                </button>
              </div>
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead class="text-muted small text-uppercase">
                    <tr>
                      <th>Photo</th>
                      <th>Name / Role</th>
                      <th>Contact No.</th>
                      <th class="text-right">Action</th>
                    </tr>
                  </thead>
                  <tbody id="teamTableBody"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- CATEGORIES -->
          <div
            class="col-lg-12 settings-tab-content d-none"
            id="tab-categories"
          >
            <div
              class="card order-card p-4 border-0 shadow-sm"
              style="border-radius: 20px"
            >
              <div
                class="d-flex justify-content-between align-items-center mb-4"
              >
                <h5 class="font-weight-bold mb-0">Menu Categories</h5>
                <button
                  class="btn btn-sm btn-primary"
                  onclick="$('#addCategoryModal').modal('show')"
                >
                  <i class="fas fa-plus mr-1"></i> Create Category
                </button>
              </div>
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead class="text-muted small text-uppercase">
                    <tr>
                      <th>ID</th>
                      <th>Display Name</th>
                      <th class="text-right">Action</th>
                    </tr>
                  </thead>
                  <tbody id="categoryTableBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Profile Management View -->
      <div id="profile-section" class="view-section">
        <div class="header-top">
          <div>
            <h2 class="font-weight-bold">Personal Command Center</h2>
            <p class="text-muted small mb-0">
              Customize your professional profile and security
            </p>
          </div>
        </div>

        <div class="row mt-4">
          <div class="col-lg-4 mb-4">
            <div
              class="card profile-header-card p-4 text-center shadow-lg"
              style="border-radius: 30px"
            >
              <div class="mb-4 position-relative d-inline-block mx-auto">
                <img
                  id="profilePreview"
                  src="../assets/img/products/default-avatar.png"
                  style="
                    width: 140px;
                    height: 140px;
                    border-radius: 50%;
                    object-fit: cover;
                    border: 4px solid rgba(255, 255, 255, 0.2);
                    background: white;
                    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
                  "
                />
                <label
                  for="profilePhotoInput"
                  class="position-absolute"
                  style="
                    bottom: 5px;
                    right: 5px;
                    background: #e7252d;
                    color: white;
                    width: 35px;
                    height: 35px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                    border: 3px solid rgba(255, 255, 255, 0.1);
                    transition: 0.3s;
                  "
                >
                  <i class="fas fa-camera" style="font-size: 0.8rem"></i>
                  <input
                    type="file"
                    id="profilePhotoInput"
                    hidden
                    accept="image/*"
                  />
                </label>
              </div>
              <h3
                id="profileDisplayName"
                class="font-weight-bold mb-1"
                style="font-size: 1.4rem"
              >
                ---
              </h3>
              <p
                id="profileDisplayRole"
                class="badge badge-pill badge-danger py-2 px-3 mb-4"
                style="
                  font-size: 0.65rem;
                  text-transform: uppercase;
                  letter-spacing: 1.5px;
                  font-weight: 800;
                  background: #e7252d;
                "
              >
                ---
              </p>

              <div
                class="text-left mt-3 p-3 rounded"
                style="
                  background: rgba(255, 255, 255, 0.05);
                  border: 1px solid rgba(255, 255, 255, 0.1);
                "
              >
                <div class="d-flex align-items-center mb-2">
                  <i
                    class="fas fa-shield-alt text-success mr-3"
                    style="width: 20px"
                  ></i>
                  <div style="font-size: 0.75rem">
                    Account Secured:
                    <span class="text-success font-weight-bold">HIGH</span>
                  </div>
                </div>
                <div class="d-flex align-items-center mb-2">
                  <i
                    class="fas fa-check-circle text-info mr-3"
                    style="width: 20px"
                  ></i>
                  <div style="font-size: 0.75rem">
                    Identity:
                    <span class="text-info font-weight-bold">VERIFIED</span>
                  </div>
                </div>
                <div class="d-flex align-items-center">
                  <i
                    class="fas fa-clock text-warning mr-3"
                    style="width: 20px"
                  ></i>
                  <div style="font-size: 0.75rem">
                    Last Login:
                    <span class="text-white-50" id="profileLastLogin"
                      >Today</span
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-8">
            <div
              class="card order-card profile-form-card p-4 border-0 shadow-sm"
              style="border-radius: 30px"
            >
              <div class="d-flex align-items-center mb-4">
                <div
                  style="
                    width: 40px;
                    height: 40px;
                    background: rgba(231, 37, 45, 0.1);
                    border-radius: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin-right: 15px;
                  "
                >
                  <i class="fas fa-user-edit text-danger"></i>
                </div>
                <h5 class="font-weight-bold mb-0">System Credentials</h5>
              </div>

              <form id="profileUpdateForm">
                <div class="row">
                  <div class="col-md-6 mb-4">
                    <label
                      class="small font-weight-bold text-muted text-uppercase mb-2"
                      style="letter-spacing: 1px; font-size: 0.65rem"
                      >Full Legal Name</label
                    >
                    <div class="profile-input-group px-3">
                      <div class="d-flex align-items-center">
                        <i class="fas fa-id-card text-muted mr-2"></i>
                        <input
                          type="text"
                          id="profileName"
                          class="form-control py-3"
                          required
                          placeholder="Your full name"
                        />
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6 mb-4">
                    <label
                      class="small font-weight-bold text-muted text-uppercase mb-2"
                      style="letter-spacing: 1px; font-size: 0.65rem"
                      >System Username</label
                    >
                    <div class="profile-input-group px-3">
                      <div class="d-flex align-items-center">
                        <i class="fas fa-at text-muted mr-2"></i>
                        <input
                          type="text"
                          id="profileUsername"
                          class="form-control py-3"
                          required
                          placeholder="username"
                        />
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6 mb-4">
                    <label
                      class="small font-weight-bold text-muted text-uppercase mb-2"
                      style="letter-spacing: 1px; font-size: 0.65rem"
                      >Work Email Address</label
                    >
                    <div class="profile-input-group px-3">
                      <div class="d-flex align-items-center">
                        <i class="fas fa-envelope text-muted mr-2"></i>
                        <input
                          type="email"
                          id="profileEmail"
                          class="form-control py-3"
                          placeholder="email@pcnc.com"
                        />
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6 mb-4">
                    <label
                      class="small font-weight-bold text-muted text-uppercase mb-2"
                      style="letter-spacing: 1px; font-size: 0.65rem"
                      >Direct Phone Contact</label
                    >
                    <div class="profile-input-group px-3">
                      <div class="d-flex align-items-center">
                        <i class="fas fa-phone text-muted mr-2"></i>
                        <input
                          type="text"
                          id="profilePhone"
                          class="form-control py-3"
                          placeholder="07..."
                        />
                      </div>
                    </div>
                  </div>
                  <div class="col-12 mt-2">
                    <div
                      class="p-4 rounded-xl"
                      style="
                        background: rgba(0, 0, 0, 0.02);
                        border: 2px dashed #eee;
                        border-radius: 20px;
                      "
                    >
                      <h6
                        class="font-weight-bold small mb-3 text-uppercase"
                        style="letter-spacing: 1px; color: #555"
                      >
                        <i class="fas fa-lock mr-2"></i>Security Authorization
                      </h6>
                      <div class="row">
                        <div class="col-md-8">
                          <div class="profile-input-group px-3 mb-2">
                            <div
                              class="input-group"
                              style="background: transparent; border: none"
                            >
                              <div class="input-group-prepend">
                                <span
                                  class="bg-transparent border-0 d-flex align-items-center pr-2"
                                  ><i class="fas fa-key text-muted"></i
                                ></span>
                              </div>
                              <input
                                type="password"
                                id="profilePassword"
                                class="form-control py-3"
                                style="
                                  background: transparent;
                                  border: none;
                                  padding-left: 0;
                                "
                                placeholder="Enter new access key to update"
                              />
                              <div class="input-group-append">
                                <button
                                  class="btn btn-link text-muted"
                                  type="button"
                                  onclick="togglePass('profilePassword')"
                                >
                                  <i class="fas fa-eye"></i>
                                </button>
                              </div>
                            </div>
                          </div>
                          <small class="text-muted d-block"
                            >Leave blank if you do not wish to change your
                            current access key.</small
                          >
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="text-right mt-5">
                  <button
                    type="submit"
                    class="btn btn-dark shadow"
                    id="profileUpdateBtn"
                    style="
                      border-radius: 16px;
                      font-weight: 800;
                      padding: 18px 45px;
                      letter-spacing: 1px;
                    "
                  >
                    <i class="fas fa-save mr-2"></i> UPDATE HQ PROFILE
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Order Modal -->
    <div class="modal fade" id="editOrderModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header border-0 p-4">
            <h5 class="modal-title font-weight-bold">Modify Order Record</h5>
            <button type="button" class="close" data-dismiss="modal">
              &times;
            </button>
          </div>
          <div class="modal-body p-4 pt-0">
            <form id="editOrderForm">
              <input type="hidden" name="orderId" />
              <div class="form-group">
                <label>Customer Name</label
                ><input type="text" name="customerName" class="form-control" />
              </div>
              <div class="form-group">
                <label>Phone Number</label
                ><input type="text" name="phoneNumber" class="form-control" />
              </div>
              <div class="form-group">
                <label>Location / Address</label
                ><input type="text" name="location" class="form-control" />
              </div>
              <div class="form-group">
                <label>Total Amount (KES)</label
                ><input type="number" name="totalAmount" class="form-control" />
              </div>
              <div class="form-group">
                <label>Payment Status</label>
                <select name="paymentStatus" class="form-control">
                  <option value="Pending">Pending</option>
                  <option value="Successful">Successful</option>
                  <option value="Failed">Failed</option>
                </select>
              </div>
              <button
                type="submit"
                class="btn btn-dark btn-block py-3 mt-3"
                style="border-radius: 12px; font-weight: 800"
              >
                Save Changes
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Category Modal -->
    <div class="modal fade" id="addCategoryModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content" style="border-radius: 20px">
          <div class="modal-header border-0 p-4">
            <h5 class="modal-title font-weight-bold">Add Menu Category</h5>
            <button type="button" class="close" data-dismiss="modal">
              &times;
            </button>
          </div>
          <div class="modal-body p-4 pt-0">
            <form id="addCategoryForm">
              <div class="form-group">
                <label>Category ID</label
                ><input
                  type="text"
                  name="catId"
                  class="form-control"
                  required
                  placeholder="e.g. desserts"
                />
              </div>
              <div class="form-group">
                <label>Display Name</label
                ><input
                  type="text"
                  name="catName"
                  class="form-control"
                  required
                  placeholder="e.g. Sweet Desserts"
                />
              </div>
              <button
                type="submit"
                class="btn btn-primary btn-block py-3 mt-4"
                style="border-radius: 12px; font-weight: 800"
              >
                Add Category
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Team Modal -->
    <div class="modal fade" id="addTeamModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius: 20px">
          <div class="modal-header border-0 p-4">
            <h5 class="modal-title font-weight-bold">Add Team Member</h5>
            <button type="button" class="close" data-dismiss="modal">
              &times;
            </button>
          </div>
          <div class="modal-body p-4 pt-0">
            <form id="addTeamForm" enctype="multipart/form-data">
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label>Full Name <span class="text-danger">*</span></label
                    ><input
                      type="text"
                      name="name"
                      class="form-control"
                      required
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label
                      >Role / Position <span class="text-danger">*</span></label
                    ><input
                      type="text"
                      name="role"
                      class="form-control"
                      required
                      placeholder="e.g. Executive Chef"
                    />
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label>Profile Photo <span class="text-danger">*</span></label>
                <div class="custom-file">
                  <input
                    type="file"
                    name="teamImg"
                    class="custom-file-input"
                    id="teamImg"
                    accept="image/*"
                    required
                  />
                  <label class="custom-file-label" for="teamImg"
                    >Choose photo</label
                  >
                </div>
              </div>

              <hr class="my-4" />
              <h6 class="font-weight-bold text-muted mb-3">
                <i class="fas fa-info-circle mr-2"></i>Optional Details
              </h6>

              <div class="form-group">
                <label
                  >Phone Number
                  <small class="text-muted">(Optional)</small></label
                >
                <input
                  type="text"
                  name="phone"
                  class="form-control"
                  placeholder="e.g. +254 712 345 678"
                />
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label
                      ><i class="fab fa-facebook text-primary"></i> Facebook
                      <small class="text-muted">(Optional)</small></label
                    >
                    <input
                      type="url"
                      name="facebook"
                      class="form-control"
                      placeholder="https://facebook.com/username"
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label
                      ><i class="fab fa-twitter text-info"></i> Twitter
                      <small class="text-muted">(Optional)</small></label
                    >
                    <input
                      type="url"
                      name="twitter"
                      class="form-control"
                      placeholder="https://twitter.com/username"
                    />
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label
                      ><i class="fab fa-instagram text-danger"></i> Instagram
                      <small class="text-muted">(Optional)</small></label
                    >
                    <input
                      type="url"
                      name="instagram"
                      class="form-control"
                      placeholder="https://instagram.com/username"
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label
                      ><i class="fab fa-linkedin text-primary"></i> LinkedIn
                      <small class="text-muted">(Optional)</small></label
                    >
                    <input
                      type="url"
                      name="linkedin"
                      class="form-control"
                      placeholder="https://linkedin.com/in/username"
                    />
                  </div>
                </div>
              </div>

              <button
                type="submit"
                class="btn btn-primary btn-block py-3 mt-4"
                style="border-radius: 12px; font-weight: 800"
              >
                Upload & Add Member
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <!-- Add Rider Modal -->
    <div class="modal fade" id="addRiderModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content" style="border-radius: 20px">
          <div class="modal-header border-0 p-4">
            <h5 class="modal-title font-weight-bold">Add Dispatch Rider</h5>
            <button type="button" class="close" data-dismiss="modal">
              &times;
            </button>
          </div>
          <div class="modal-body p-4 pt-0">
            <form id="addRiderForm" enctype="multipart/form-data">
              <div class="form-group">
                <label>Full Name <span class="text-danger">*</span></label
                ><input type="text" name="name" class="form-control" required />
              </div>
              <div class="form-group">
                <label>Phone Number <span class="text-danger">*</span></label
                ><input
                  type="text"
                  name="phone"
                  class="form-control"
                  required
                  placeholder="07... or 254..."
                />
              </div>
              <div class="form-group">
                <label
                  >Vehicle Plate / ID
                  <small class="text-muted">(Optional)</small></label
                ><input
                  type="text"
                  name="vehicle"
                  class="form-control"
                  placeholder="e.g. KMDX 123G"
                />
              </div>
              <div class="form-group">
                <label>Profile Photo <span class="text-danger">*</span></label>
                <div class="custom-file">
                  <input
                    type="file"
                    name="riderImg"
                    class="custom-file-input"
                    id="riderImg"
                    accept="image/*"
                    required
                  />
                  <label class="custom-file-label" for="riderImg"
                    >Choose photo</label
                  >
                </div>
              </div>
              <button
                type="submit"
                class="btn btn-success btn-block py-3 mt-4"
                style="border-radius: 12px; font-weight: 800"
              >
                Register Rider
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="addMenuModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content" style="border-radius: 20px">
          <div class="modal-header border-0 p-4">
            <h5 class="modal-title font-weight-bold">Add Menu Item</h5>
            <button type="button" class="close" data-dismiss="modal">
              &times;
            </button>
          </div>
          <div class="modal-body p-4 pt-0">
            <form id="addMenuForm" enctype="multipart/form-data">
              <div class="form-group">
                <label>Product Name</label
                ><input
                  type="text"
                  name="name"
                  class="form-control"
                  required
                  placeholder="e.g. Hawaiian Pizza"
                />
              </div>
              <div class="form-group">
                <label>Price (KES)</label
                ><input
                  type="number"
                  name="price"
                  class="form-control"
                  required
                  placeholder="1000"
                />
              </div>
              <div class="form-group">
                <label>Category</label>
                <select
                  name="category"
                  class="form-control"
                  id="addMenuCategoryDropdown"
                >
                  <option value="pizza">Pizza</option>
                  <option value="burgers">Burgers</option>
                  <option value="snacks">Snacks</option>
                </select>
              </div>
              <div class="form-group">
                <label>Product Photo</label>
                <div class="custom-file">
                  <input
                    type="file"
                    name="imageFile"
                    class="custom-file-input"
                    id="menuImage"
                    accept="image/*"
                  />
                  <label class="custom-file-label" for="menuImage"
                    >Choose file</label
                  >
                </div>
              </div>
              <div class="form-group">
                <label>Tag (Optional)</label
                ><input
                  type="text"
                  name="tag"
                  class="form-control"
                  placeholder="e.g. Bestseller"
                />
              </div>
              <button
                type="submit"
                class="btn btn-primary btn-block py-3 mt-4"
                style="border-radius: 12px; font-weight: 800"
              >
                Upload & Add to Menu
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Order Modal -->
    <div class="modal fade" id="editOrderModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content" style="border-radius: 20px">
          <div class="modal-header border-0 p-4">
            <h5 class="modal-title font-weight-bold">Edit Order Details</h5>
            <button type="button" class="close" data-dismiss="modal">
              &times;
            </button>
          </div>
          <div class="modal-body p-4 pt-0">
            <form id="editOrderForm">
              <input type="hidden" name="orderId" />
              <div class="form-group">
                <label>Customer Name</label
                ><input
                  type="text"
                  name="customerName"
                  class="form-control"
                  required
                />
              </div>
              <div class="form-group">
                <label>Phone</label
                ><input
                  type="text"
                  name="phoneNumber"
                  class="form-control"
                  required
                />
              </div>
              <div class="form-group">
                <label>Delivery Location</label
                ><input
                  type="text"
                  name="location"
                  class="form-control"
                  required
                />
              </div>
              <div class="row">
                <div class="col-6">
                  <div class="form-group">
                    <label>Total Amount</label
                    ><input
                      type="number"
                      name="totalAmount"
                      class="form-control"
                      required
                    />
                  </div>
                </div>
                <div class="col-6">
                  <div class="form-group">
                    <label>Payment Status</label>
                    <select name="paymentStatus" class="form-control">
                      <option value="Pending">Pending</option>
                      <option value="Successful">Successful</option>
                      <option value="Failed">Failed</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label>Estimated Arrival Time (ETA)</label>
                <input
                  type="text"
                  name="estimatedTime"
                  class="form-control"
                  placeholder="e.g. 45 mins, 7:30 PM"
                />
                <small class="text-muted"
                  >Will be visible to customer on tracking page</small
                >
              </div>
              <button
                type="submit"
                class="btn btn-primary btn-block py-3 mt-4"
                style="border-radius: 12px; font-weight: 800"
              >
                Update Order
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <!-- Edit Category Modal -->
    <div class="modal fade" id="editCategoryModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content" style="border-radius: 20px">
          <div class="modal-header border-0 p-4">
            <h5 class="modal-title font-weight-bold">Edit Menu Category</h5>
            <button type="button" class="close" data-dismiss="modal">
              &times;
            </button>
          </div>
          <div class="modal-body p-4 pt-0">
            <form id="editCategoryForm">
              <input type="hidden" name="oldId" />
              <div class="form-group">
                <label>Category ID</label
                ><input
                  type="text"
                  name="catId"
                  class="form-control"
                  required
                />
              </div>
              <div class="form-group">
                <label>Display Name</label
                ><input
                  type="text"
                  name="catName"
                  class="form-control"
                  required
                />
              </div>
              <button
                type="submit"
                class="btn btn-primary btn-block py-3 mt-4"
                style="border-radius: 12px; font-weight: 800"
              >
                Save Changes
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Team Member Modal -->
    <div class="modal fade" id="editTeamModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius: 20px">
          <div class="modal-header border-0 p-4">
            <h5 class="modal-title font-weight-bold">Edit Team Member</h5>
            <button type="button" class="close" data-dismiss="modal">
              &times;
            </button>
          </div>
          <div class="modal-body p-4 pt-0">
            <form id="editTeamForm" enctype="multipart/form-data">
              <input type="hidden" name="id" />
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label>Full Name <span class="text-danger">*</span></label
                    ><input
                      type="text"
                      name="name"
                      class="form-control"
                      required
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label
                      >Role / Position <span class="text-danger">*</span></label
                    ><input
                      type="text"
                      name="role"
                      class="form-control"
                      required
                    />
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label
                  >New Profile Photo
                  <small class="text-muted"
                    >(Leave blank to keep current)</small
                  ></label
                >
                <div class="custom-file">
                  <input
                    type="file"
                    name="teamImg"
                    class="custom-file-input"
                    id="editTeamImg"
                    accept="image/*"
                  />
                  <label class="custom-file-label" for="editTeamImg"
                    >Choose photo</label
                  >
                </div>
              </div>
              <div class="form-group">
                <label>Phone Number</label>
                <input type="text" name="phone" class="form-control" />
              </div>
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label>Facebook</label
                    ><input type="url" name="facebook" class="form-control" />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label>Twitter</label
                    ><input type="url" name="twitter" class="form-control" />
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label>Instagram</label
                    ><input type="url" name="instagram" class="form-control" />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label>LinkedIn</label
                    ><input type="url" name="linkedin" class="form-control" />
                  </div>
                </div>
              </div>
              <button
                type="submit"
                class="btn btn-primary btn-block py-3 mt-4"
                style="border-radius: 12px; font-weight: 800"
              >
                Save Changes
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Rider Modal -->
    <div class="modal fade" id="editRiderModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content" style="border-radius: 20px">
          <div class="modal-header border-0 p-4">
            <h5 class="modal-title font-weight-bold">Edit Dispatch Rider</h5>
            <button type="button" class="close" data-dismiss="modal">
              &times;
            </button>
          </div>
          <div class="modal-body p-4 pt-0">
            <form id="editRiderForm" enctype="multipart/form-data">
              <input type="hidden" name="id" />
              <div class="form-group">
                <label>Full Name <span class="text-danger">*</span></label
                ><input type="text" name="name" class="form-control" required />
              </div>
              <div class="form-group">
                <label>Phone Number <span class="text-danger">*</span></label
                ><input
                  type="text"
                  name="phone"
                  class="form-control"
                  required
                />
              </div>
              <div class="form-group">
                <label>Vehicle Plate / ID</label
                ><input type="text" name="vehicle" class="form-control" />
              </div>
              <div class="form-group">
                <label
                  >New Profile Photo
                  <small class="text-muted"
                    >(Leave blank to keep current)</small
                  ></label
                >
                <div class="custom-file">
                  <input
                    type="file"
                    name="riderImg"
                    class="custom-file-input"
                    id="editRiderImg"
                    accept="image/*"
                  />
                  <label class="custom-file-label" for="editRiderImg"
                    >Choose photo</label
                  >
                </div>
              </div>
              <button
                type="submit"
                class="btn btn-success btn-block py-3 mt-4"
                style="border-radius: 12px; font-weight: 800"
              >
                Save Changes
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Menu Modal -->
    <div class="modal fade" id="editMenuModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content" style="border-radius: 20px">
          <div class="modal-header border-0 p-4">
            <h5 class="modal-title font-weight-bold">Edit Menu Item</h5>
            <button type="button" class="close" data-dismiss="modal">
              &times;
            </button>
          </div>
          <div class="modal-body p-4 pt-0">
            <form id="editMenuForm" enctype="multipart/form-data">
              <input type="hidden" name="id" />
              <div class="form-group">
                <label>Product Name</label
                ><input type="text" name="name" class="form-control" required />
              </div>
              <div class="form-group">
                <label>Price (KES)</label
                ><input
                  type="number"
                  name="price"
                  class="form-control"
                  required
                />
              </div>
              <div class="form-group">
                <label>Category</label>
                <select
                  name="category"
                  class="form-control"
                  id="editMenuCategoryDropdown"
                ></select>
              </div>
              <div class="form-group">
                <label
                  >Update Photo
                  <small class="text-muted">(Optional)</small></label
                >
                <div class="custom-file">
                  <input
                    type="file"
                    name="imageFile"
                    class="custom-file-input"
                    id="editMenuImage"
                    accept="image/*"
                  />
                  <label class="custom-file-label" for="editMenuImage"
                    >Choose file</label
                  >
                </div>
              </div>
              <div class="form-group">
                <label>Tag (Optional)</label
                ><input type="text" name="tag" class="form-control" />
              </div>
              <button
                type="submit"
                class="btn btn-primary btn-block py-3 mt-4"
                style="border-radius: 12px; font-weight: 800"
              >
                Save Changes
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="addPromoModal" tabindex="-1">
      <div class="modal-dialog modal-sm">
        <div class="modal-content" style="border-radius: 20px">
          <div class="modal-header border-0 p-4">
            <h5 class="modal-title font-weight-bold">Add Promo Code</h5>
            <button type="button" class="close" data-dismiss="modal">
              &times;
            </button>
          </div>
          <div class="modal-body p-4 pt-0">
            <form id="addPromoForm">
              <div class="form-group">
                <label>Promo Code</label
                ><input
                  type="text"
                  name="code"
                  class="form-control"
                  placeholder="e.g. WELCOME10"
                  required
                />
              </div>
              <div class="form-group">
                <label>Discount (%)</label
                ><input
                  type="number"
                  name="discount"
                  class="form-control"
                  placeholder="10"
                  required
                />
              </div>
              <button
                type="submit"
                class="btn btn-primary btn-block py-3 mt-4"
                style="border-radius: 12px; font-weight: 800"
              >
                Create Code
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick ETA Selection Modal -->
    <div class="modal fade" id="quickETAModal" tabindex="-1">
      <div class="modal-dialog modal-sm">
        <div class="modal-content" style="border-radius: 20px">
          <div class="modal-header border-0 p-4">
            <h5 class="modal-title font-weight-bold">Set Arrival Time</h5>
            <button type="button" class="close" data-dismiss="modal">
              &times;
            </button>
          </div>
          <div class="modal-body p-4 pt-0">
            <input type="hidden" id="etaOrderId" />
            <div class="d-grid gap-2 mb-3">
              <button
                class="btn btn-outline-primary btn-block mb-2"
                onclick="selectETA('15 mins')"
              >
                15 Mins
              </button>
              <button
                class="btn btn-outline-primary btn-block mb-2"
                onclick="selectETA('30 mins')"
              >
                30 Mins
              </button>
              <button
                class="btn btn-outline-primary btn-block mb-2"
                onclick="selectETA('45 mins')"
              >
                45 Mins
              </button>
              <button
                class="btn btn-outline-primary btn-block mb-2"
                onclick="selectETA('60 mins')"
              >
                60 Mins
              </button>
            </div>
            <div class="form-group">
              <label class="small font-weight-bold">Custom Time</label>
              <input
                type="text"
                id="customETA"
                class="form-control"
                placeholder="e.g. 2:30 PM"
              />
            </div>
            <button
              class="btn btn-dark btn-block py-3 mt-3"
              style="border-radius: 12px; font-weight: 800"
              onclick="saveCustomETA()"
            >
              Save Time
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Map Modal -->
    <div class="modal fade" id="orderMapModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div
          class="modal-content"
          style="border-radius: 24px; overflow: hidden; border: none"
        >
          <div class="modal-header border-0 bg-dark text-white p-4">
            <h5 class="modal-title font-weight-bold" id="mapModalTitle">
              Order Location
            </h5>
            <button type="button" class="close text-white" data-dismiss="modal">
              &times;
            </button>
          </div>
          <div class="modal-body p-0">
            <div
              id="orderMapView"
              style="height: 450px; background: #eee"
            ></div>
          </div>
          <div class="modal-footer border-0 p-4">
            <div id="mapDirectionsLink" class="w-100"></div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <script src="../assets/js/jquery-1.11.3.min.js"></script>
    <script src="../assets/bootstrap/js/bootstrap.min.js"></script>
    <script>
      // Session Manager - Allows multiple admins to be logged in simultaneously
      const SessionManager = {
        // Get all active sessions
        getAllSessions() {
          const sessions = localStorage.getItem("adminSessions");
          return sessions ? JSON.parse(sessions) : {};
        },

        // Get current session ID
        getCurrentSessionId() {
          return sessionStorage.getItem("currentSessionId");
        },

        // Get current session data
        getCurrentSession() {
          const sessionId = this.getCurrentSessionId();
          if (!sessionId) return null;

          const sessions = this.getAllSessions();
          return sessions[sessionId] || null;
        },

        // Update session activity
        updateActivity(sessionId) {
          const sessions = this.getAllSessions();
          if (sessions[sessionId]) {
            sessions[sessionId].lastActivity = new Date().toISOString();
            localStorage.setItem("adminSessions", JSON.stringify(sessions));
          }
        },

        // Remove a specific session (logout)
        removeSession(sessionId) {
          const sessions = this.getAllSessions();
          delete sessions[sessionId];
          localStorage.setItem("adminSessions", JSON.stringify(sessions));

          // If this was the current session, clear it from sessionStorage
          if (this.getCurrentSessionId() === sessionId) {
            sessionStorage.removeItem("currentSessionId");
          }
        },

        // Get all active admin names (for display)
        getActiveAdmins() {
          const sessions = this.getAllSessions();
          return Object.values(sessions).map((s) => s.staffName);
        },
      };

      // Auth Check - Verify current session exists
      const currentSession = SessionManager.getCurrentSession();
      if (!currentSession) {
        window.location.href = "index.html";
      }

      // Display admin name and role-based UI
      if (currentSession && currentSession.staffName) {
        // Show profile link for everyone (but user specifically asked to ensure employees have it)
        document.getElementById("profileNavLink").style.display = "flex";

        // REMOVE PROFILE CIRCLE FOR SUPER ADMIN (per user request)
        if (currentSession.role === "super-admin") {
          document.getElementById("adminNameDisplay").style.display = "none";
        } else {
          document.getElementById("adminNameDisplay").style.display = "block";
          document.getElementById("adminNameText").innerText =
            currentSession.staffName;
          if (currentSession.profilePhoto) {
            document.getElementById("adminProfilePhoto").src =
              currentSession.profilePhoto;
          }
        }

        // If super-admin, show restricted links
        if (currentSession.role === "super-admin") {
          document.getElementById("restrictedNav").style.display = "block";
          document.getElementById("viewerModeWrapper").style.display = "block";
        }
      }

      // Logout function - Notifies server and clears local session
      async function logout() {
        const sessionId = SessionManager.getCurrentSessionId();
        const session = SessionManager.getCurrentSession();

        if (sessionId && session) {
          try {
            await fetch("/api/admin/logout", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                username: session.username,
                sessionId: sessionId,
              }),
            });
          } catch (e) {
            console.error("Logout notification failed", e);
          }

          SessionManager.removeSession(sessionId);
        }
        window.location.href = "index.html";
      }

      async function adminFetch(url, options = {}) {
        const session = SessionManager.getCurrentSession();
        if (!session) {
          window.location.href = "index.html";
          throw new Error("No active session");
        }

        // Update activity timestamp
        SessionManager.updateActivity(SessionManager.getCurrentSessionId());

        const defaultHeaders = {
          Authorization: `Bearer ${session.token}`,
          "X-Staff-Name": session.staffName || "Admin",
          "X-Admin-Session-Id": SessionManager.getCurrentSessionId(),
          "X-Admin-Username": session.username,
        };

        // Don't override content-type if it's already set or if it's FormData
        if (!(options.body instanceof FormData)) {
          defaultHeaders["Content-Type"] = "application/json";
        }

        const mergedOptions = {
          ...options,
          headers: {
            ...defaultHeaders,
            ...(options.headers || {}),
          },
        };

        const res = await fetch(url, mergedOptions);
        if (res.status === 401) {
          // Only remove current session on auth failure
          SessionManager.removeSession(SessionManager.getCurrentSessionId());
          window.location.href = "index.html";
          throw new Error("Unauthorized");
        }
        return res;
      }

      // Update Active Sessions Display (Strictly 2 Admins - Fetched from Server)
      async function updateActiveSessionsDisplay() {
        try {
          // Cache busting query to ensure we get fresh state
          const res = await adminFetch(
            `/api/admin/active-sessions?t=${Date.now()}`
          );
          if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);

          const data = await res.json();

          if (data.success) {
            const onlineAdmins = data.onlineAdmins || []; // Array of names

            const now = new Date();
            const timestamp = now.toLocaleTimeString([], {
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit",
            });

            let html = "";
            if (onlineAdmins.length === 0) {
              html =
                '<div class="text-center py-2 small text-muted">No sessions active</div>';
            } else {
              onlineAdmins.forEach((name) => {
                html += `
                                <div style="padding: 10px 0; display: flex; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    <div style="width: 8px; height: 8px; border-radius: 50%; background: #28a745; margin-right: 12px; box-shadow: 0 0 10px #28a745;"></div>
                                    <div style="flex-grow: 1;">
                                        <div style="font-weight: 700; color: #fff; font-size: 0.8rem; letter-spacing: 0.5px;">${name.toUpperCase()}</div>
                                        <div style="font-size: 0.55rem; color: #28a745; text-transform: uppercase; font-weight: 800; letter-spacing: 1px;">Authorized Online</div>
                                    </div>
                                </div>
                            `;
              });
            }

            html += `
                        <div style="padding-top: 10px; font-size: 0.55rem; color: #555; text-align: center; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
                            <i class="fas fa-heartbeat" style="color: #e7252d; margin-right: 4px;"></i> Live Sync: ${timestamp}
                        </div>
                    `;

            document.getElementById("activeSessionsList").innerHTML = html;
            document.getElementById("activeSessionsDisplay").style.display =
              "block";
          }
        } catch (e) {
          console.error("Authorized Access Status Update Error:", e);
        }
      }

      let allOrders = [];
      let allRiders = [];
      let currentView = "dashboard";
      let lastKnownOrderId = null;
      let isManagementMode = false; // Default for super-admins
      let salesChartInstance = null;
      let categoryChartInstance = null;

      function toggleManagementMode() {
        isManagementMode = document.getElementById(
          "managementModeToggle"
        ).checked;
        showNotification(
          "Mode Updated",
          isManagementMode
            ? "Order Management Enabled"
            : "Viewer Mode Activated",
          "info"
        );
        renderOrders();
      }
      let customerChartInstance = null;

      function switchView(view) {
        currentView = view;
        $(".view-section").removeClass("active");
        $("#sidebarNav a").removeClass("active");
        $(`a[data-view="${view}"]`).addClass("active");

        if (view === "menu") {
          $("#menu-section").addClass("active");
          loadMenu();
        } else if (view === "analytics") {
          if (currentSession.role !== "super-admin")
            return switchView("dashboard");
          $("#analytics-section").addClass("active");
          loadData();
        } else if (view === "settings") {
          if (currentSession.role !== "super-admin")
            return switchView("dashboard");
          $("#settings-section").addClass("active");
          loadSettings();
        } else if (view === "staff") {
          if (currentSession.role !== "super-admin")
            return switchView("dashboard");
          $("#staff-section").addClass("active");
          loadStaff();
        } else if (view === "profile") {
          $("#profile-section").addClass("active");
          loadProfile();
        } else {
          $("#orders-section").addClass("active");

          // Update header text based on view
          if (view === "active") {
            $("#viewTitle").text("Active Kitchen Pipeline");
            $("#viewSubtitle").text("Managing fresh incoming orders");
          } else if (view === "history") {
            $("#viewTitle").text("Archived Order Records");
            $("#viewSubtitle").text("Reviewing completed deliveries and sales");
          } else {
            $("#viewTitle").text("Live Operations");
            $("#viewSubtitle").text(
              "Real-time order tracking & kitchen management"
            );
          }

          loadData();
        }
      }

      function showSettingsTab(tabId, btn) {
        $(".settings-tab-content").addClass("d-none");
        $(`#tab-${tabId}`).removeClass("d-none");
        $(".settings-nav-btn")
          .removeClass("btn-dark active")
          .addClass("btn-outline-dark");
        $(btn).removeClass("btn-outline-dark").addClass("btn-dark active");
      }

      async function saveGlobalWhatsapp() {
        const num = $("#globalWhatsappInput").val();
        try {
          const res = await adminFetch("/api/admin/settings/update", {
            method: "POST",
            body: JSON.stringify({ whatsappNumber: num }),
          });
          if (res.ok) {
            showNotification(
              "Updated",
              "Global WhatsApp contact saved",
              "success"
            );
          }
        } catch (e) {
          console.error(e);
        }
      }

      function showNotification(title, msg, type = "success") {
        const toast = document.createElement("div");
        toast.className = `alert alert-${
          type === "success" ? "primary" : "danger"
        } shadow-lg`;
        toast.style.cssText = `position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; border-radius: 12px; border-left: 5px solid ${
          type === "success" ? "#28a745" : "#dc3545"
        };`;
        toast.innerHTML = `<strong>${title}</strong><br><small>${msg}</small>`;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
      }

      function handleRefresh() {
        showNotification(
          "Refreshing...",
          "Fetching latest data from kitchen",
          "success"
        );
        loadData();
      }

      // Order Age Calculation
      function getOrderAge(orderDate) {
        const now = new Date();
        const orderTime = new Date(orderDate);
        const diffMs = now - orderTime;
        const diffMins = Math.floor(diffMs / 60000);

        if (diffMins < 1) return "Just now";
        if (diffMins < 60) return `${diffMins}m ago`;
        const diffHours = Math.floor(diffMins / 60);
        if (diffHours < 24) return `${diffHours}h ago`;
        const diffDays = Math.floor(diffHours / 24);
        return `${diffDays}d ago`;
      }

      // Order Age Badge Color (green = fresh, yellow = moderate, red = old)
      function getOrderAgeBadgeColor(orderDate) {
        const diffMins = Math.floor((new Date() - new Date(orderDate)) / 60000);
        if (diffMins < 15) return "#28a745"; // Green - Fresh
        if (diffMins < 30) return "#ffc107"; // Yellow - Moderate
        if (diffMins < 60) return "#ff9800"; // Orange - Getting old
        return "#dc3545"; // Red - Very old
      }

      // Staff Management logic
      async function loadStaff() {
        if (currentSession.role !== "super-admin") return;
        try {
          const res = await adminFetch("/api/admin/staff/list");
          const data = await res.json();
          if (data.success) {
            const tbody = $("#staffTable").empty();
            data.staff.forEach((s) => {
              const statusClass =
                s.status === "approved"
                  ? "badge-success"
                  : s.status === "rejected"
                  ? "badge-danger"
                  : "badge-warning";
              const photo =
                s.profilePhoto || "../assets/img/products/default-avatar.png";
              const isBlocked = s.isBlocked || false;

              let actions = "";
              if (s.status === "pending") {
                actions = `
                                <button class="btn btn-sm btn-outline-success" onclick="handleStaffAction('${s.username}', 'approved')" title="Approve"><i class="fas fa-check"></i></button>
                                <button class="btn btn-sm btn-outline-warning" onclick="handleStaffAction('${s.username}', 'rejected')" title="Reject"><i class="fas fa-times"></i></button>
                            `;
              } else {
                actions = `
                                <button class="btn btn-sm btn-outline-${
                                  isBlocked ? "info" : "secondary"
                                }" onclick="handleStaffAction('${
                  s.username
                }', '${isBlocked ? "unblock" : "block"}')" title="${
                  isBlocked ? "Unblock" : "Block"
                } User">
                                    <i class="fas fa-${
                                      isBlocked ? "unlock" : "user-lock"
                                    }"></i>
                                </button>
                            `;
              }

              tbody.append(`
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img src="${photo}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-right: 15px; border: 3px solid ${
                isBlocked ? "#6c757d" : "#e7252d"
              }; background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                                        <div>
                                            <div class="font-weight-bold" style="font-size: 1rem; color: #1a1a1a;">${
                                              s.name
                                            } ${
                isBlocked
                  ? '<span class="badge badge-secondary ml-1" style="font-size: 0.6rem;">BLOCKED</span>'
                  : ""
              }</div>
                                            <div class="small text-danger font-weight-bold" style="letter-spacing: 0.5px;">@${
                                              s.username
                                            }</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="small mb-1"><i class="fas fa-envelope text-muted mr-2" style="width: 14px;"></i> ${
                                      s.email ||
                                      '<span class="text-muted font-italic">No Email</span>'
                                    }</div>
                                    <div class="small"><i class="fas fa-phone text-muted mr-2" style="width: 14px;"></i> ${
                                      s.phone ||
                                      '<span class="text-muted font-italic">No Phone</span>'
                                    }</div>
                                </td>
                                <td><span class="badge ${statusClass}" style="padding: 8px 14px; border-radius: 50px; font-weight: 700; letter-spacing: 0.5px;">${s.status.toUpperCase()}</span></td>
                                <td class="small text-muted font-weight-bold">${new Date(
                                  s.createdAt
                                ).toLocaleDateString(undefined, {
                                  year: "numeric",
                                  month: "short",
                                  day: "numeric",
                                })}</td>
                                <td class="text-right">
                                    <div class="btn-group shadow-sm" style="border-radius: 10px; overflow: hidden;">
                                        ${actions}
                                        <button class="btn btn-sm btn-light text-danger" onclick="handleStaffAction('${
                                          s.username
                                        }', 'delete')" title="Permanent Delete"><i class="fas fa-trash-alt"></i></button>
                                    </div>
                                </td>
                            </tr>
                        `);
            });
          }
        } catch (e) {
          console.error(e);
        }
      }

      async function handleStaffAction(username, action) {
        if (!confirm(`Are you sure you want to ${action} this staff member?`))
          return;
        try {
          const res = await adminFetch("/api/admin/staff/action", {
            method: "POST",
            body: JSON.stringify({ username, action }),
          });
          const data = await res.json();
          if (data.success) {
            showNotification(
              "Staff Updated",
              `User ${username} ${action} successfully.`,
              "success"
            );
            loadStaff();
          }
        } catch (e) {
          console.error(e);
        }
      }

      // --- PROFILE MANAGEMENT ---
      function togglePass(id) {
        const el = document.getElementById(id);
        el.type = el.type === "password" ? "text" : "password";
      }

      function toBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = () => resolve(reader.result);
          reader.onerror = (error) => reject(error);
        });
      }

      function loadProfile() {
        const s = SessionManager.getCurrentSession();
        if (!s) return;

        document.getElementById("profileDisplayName").innerText = s.staffName;
        document.getElementById("profileDisplayRole").innerText = s.role;
        document.getElementById("profilePreview").src =
          s.profilePhoto || "../assets/img/products/default-avatar.png";

        document.getElementById("profileName").value = s.staffName;
        document.getElementById("profileUsername").value = s.username;
        document.getElementById("profileEmail").value = s.email || "";
        document.getElementById("profilePhone").value = s.phone || "";
        document.getElementById("profilePassword").value = "";

        if (s.loginTime) {
          const date = new Date(s.loginTime);
          document.getElementById("profileLastLogin").innerText =
            date.toLocaleDateString() +
            " " +
            date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
        }
      }

      document
        .getElementById("profilePhotoInput")
        .addEventListener("change", async function (e) {
          if (e.target.files[0]) {
            const base64 = await toBase64(e.target.files[0]);
            document.getElementById("profilePreview").src = base64;
          }
        });

      document
        .getElementById("profileUpdateForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const btn = document.getElementById("profileUpdateBtn");
          const originalText = btn.innerText;
          btn.innerText = "Updating Profile...";
          btn.disabled = true;

          try {
            const photoInput = document.getElementById("profilePhotoInput");
            let profilePhoto = document.getElementById("profilePreview").src;

            // If it's a relative path, we don't need to re-upload it unless it's a data URI
            if (!profilePhoto.startsWith("data:")) {
              profilePhoto = ""; // Endpoint will keep current if not provided or handle mapping
            }

            const data = {
              name: document.getElementById("profileName").value,
              username: document.getElementById("profileUsername").value,
              email: document.getElementById("profileEmail").value,
              phone: document.getElementById("profilePhone").value,
            };

            const password = document.getElementById("profilePassword").value;
            if (password) data.password = password;
            if (profilePhoto) data.profilePhoto = profilePhoto;

            const res = await adminFetch("/api/admin/profile/update", {
              method: "POST",
              body: JSON.stringify(data),
            });

            const result = await res.json();
            if (result.success) {
              showNotification(
                "Success",
                "Profile updated successfully",
                "success"
              );

              // Update Local Session
              const sessionId = SessionManager.getCurrentSessionId();
              const sessions = SessionManager.getAllSessions();
              if (sessions[sessionId]) {
                sessions[sessionId].staffName = result.staffName;
                sessions[sessionId].username = result.username;
                if (result.profilePhoto)
                  sessions[sessionId].profilePhoto = result.profilePhoto;
                sessions[sessionId].email = result.email;
                sessions[sessionId].phone = result.phone;
                localStorage.setItem("adminSessions", JSON.stringify(sessions));

                // Refresh display
                loadProfile();
                // Refresh sidebar if employee
                if (
                  result.profilePhoto &&
                  currentSession.role !== "super-admin"
                ) {
                  document.getElementById("adminProfilePhoto").src =
                    result.profilePhoto;
                }
                if (currentSession.role !== "super-admin") {
                  document.getElementById("adminNameText").innerText =
                    result.staffName;
                }
              }
            } else {
              showNotification(
                "Error",
                result.message || "Update failed",
                "danger"
              );
            }
          } catch (err) {
            console.error(err);
            showNotification("Error", "Server connection failed", "danger");
          } finally {
            btn.innerText = originalText;
            btn.disabled = false;
          }
        });

      // Update order ages every minute
      setInterval(() => {
        document.querySelectorAll(".order-age").forEach((el) => {
          const orderDate = el.getAttribute("data-date");
          const badge = el.querySelector(".badge");
          if (badge) {
            badge.textContent = getOrderAge(orderDate);
            badge.style.background = getOrderAgeBadgeColor(orderDate);
          }
        });
      }, 60000); // Update every minute

      // Real-time Clock
      function updateClock() {
        const now = new Date();
        const timeOptions = {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
          hour12: false,
        };
        const dateOptions = {
          weekday: "short",
          year: "numeric",
          month: "short",
          day: "numeric",
        };

        const clockTime = document.getElementById("clockTime");
        const clockDate = document.getElementById("clockDate");

        if (clockTime)
          clockTime.textContent = now.toLocaleTimeString("en-US", timeOptions);
        if (clockDate)
          clockDate.textContent = now.toLocaleDateString("en-US", dateOptions);
      }

      // Update clock every second
      setInterval(updateClock, 1000);
      updateClock(); // Initial call

      async function loadData() {
        try {
          // Fetch both orders and settings to keep rider list fresh for dropdowns
          const [ordersRes, settingsRes] = await Promise.all([
            adminFetch("/api/admin/orders"),
            fetch("/api/settings?_=" + new Date().getTime()),
          ]);

          allOrders = await ordersRes.json();
          const settings = await settingsRes.json();
          allRiders = settings.riders || [];

          // Real-time sound notification
          if (
            allOrders.length > 0 &&
            lastKnownOrderId &&
            allOrders[0].id !== lastKnownOrderId
          ) {
            new Audio(
              "https://assets.mixkit.co/active_storage/sfx/2857/2857-preview.mp3"
            ).play();
          }
          lastKnownOrderId = allOrders.length > 0 ? allOrders[0].id : null;

          renderStats();
          renderCharts();
          renderOrders();
          renderRiders();
        } catch (e) {
          console.error(e);
        }
      }

      function renderRiders() {
        const riderTbody = $("#riderTableBody").empty();
        if (allRiders.length > 0) {
          allRiders.forEach((r) => {
            riderTbody.append(`
                        <tr>
                            <td><img src="../${
                              r.image
                            }" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #eee;"></td>
                            <td>
                                <div class="font-weight-bold">${r.name}</div>
                                <div class="small text-muted">${r.phone}</div>
                                ${
                                  r.vehicle
                                    ? `<div class="small text-danger font-weight-bold"><i class="fas fa-motorcycle mr-1"></i>${r.vehicle}</div>`
                                    : ""
                                }
                            </td>
                            <td class="text-right">
                                <button class="btn btn-sm btn-outline-primary mr-1" onclick="openEditRider('${
                                  r.id
                                }')" style="border-radius: 8px;"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteRider('${
                                  r.id
                                }')" style="border-radius: 8px;"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `);
          });
        } else {
          riderTbody.append(
            '<tr><td colspan="3" class="text-center text-muted p-4">No dispatch riders registered yet</td></tr>'
          );
        }
      }

      function renderStats() {
        const today = new Date().toISOString().split("T")[0];
        const daily = allOrders.filter((o) => o.date.startsWith(today));
        const revenue = daily.reduce(
          (sum, o) =>
            sum +
            (o.paymentStatus === "Successful" ? parseInt(o.totalAmount) : 0),
          0
        );
        const active = allOrders.filter((o) => o.status !== "Completed").length;
        const unpaid = allOrders.filter(
          (o) => o.paymentStatus !== "Successful"
        ).length;

        $("#statsRow").html(`
                <div class="col-md-3"><div class="stat-card"><h5>Today's Orders</h5><h2>${
                  daily.length
                }</h2></div></div>
                <div class="col-md-3"><div class="stat-card"><h5>Today's Sales</h5><h2>KES ${revenue.toLocaleString()}</h2></div></div>
                <div class="col-md-3"><div class="stat-card"><h5>Unpaid Orders</h5><h2>${unpaid}</h2></div></div>
                <div class="col-md-3"><div class="stat-card"><h5>Active In Kitchen</h5><h2>${active}</h2></div></div>
            `);
      }

      function renderCharts() {
        if (currentView !== "analytics") return;

        const ctx = document.getElementById("salesChart");
        if (!ctx) return;

        // Generate last 7 days labels
        const labels = [];
        const data = [];
        for (let i = 6; i >= 0; i--) {
          const date = new Date();
          date.setDate(date.getDate() - i);
          const dateStr = date.toISOString().split("T")[0];
          labels.push(
            date.toLocaleDateString([], { weekday: "short", day: "numeric" })
          );

          const dayTotal = allOrders
            .filter(
              (o) =>
                o.date.startsWith(dateStr) && o.paymentStatus === "Successful"
            )
            .reduce((sum, o) => sum + parseInt(o.totalAmount), 0);
          data.push(dayTotal);
        }

        if (salesChartInstance) salesChartInstance.destroy();

        salesChartInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Revenue (KES)",
                data: data,
                borderColor: "#e7252d",
                backgroundColor: "rgba(231, 37, 45, 0.1)",
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                pointBackgroundColor: "#e7252d",
                pointRadius: 5,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: { beginAtZero: true, grid: { display: false } },
              x: { grid: { display: false } },
            },
          },
        });

        // 2. Category Pie Chart
        const catCtx = document.getElementById("categoryChart");
        if (catCtx) {
          const catCount = {};
          allOrders.forEach((o) => {
            o.items.forEach((i) => {
              const cat = i.category || "Other";
              catCount[cat] = (catCount[cat] || 0) + i.quantity;
            });
          });

          if (categoryChartInstance) categoryChartInstance.destroy();
          categoryChartInstance = new Chart(catCtx, {
            type: "doughnut",
            data: {
              labels: Object.keys(catCount).map((c) => c.toUpperCase()),
              datasets: [
                {
                  data: Object.values(catCount),
                  backgroundColor: [
                    "#e7252d",
                    "#1a1a1a",
                    "#ffc107",
                    "#28a745",
                    "#17a2b8",
                    "#6610f2",
                  ],
                  borderWidth: 0,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { position: "right" } },
            },
          });
        }

        // 3. Customer Growth
        const custCtx = document.getElementById("customerChart");
        if (custCtx) {
          const custHistory = {};
          allOrders.forEach((o) => {
            if (!custHistory[o.phoneNumber]) custHistory[o.phoneNumber] = 0;
            custHistory[o.phoneNumber]++;
          });

          const returning = Object.values(custHistory).filter(
            (c) => c > 1
          ).length;
          const newCust = Object.values(custHistory).filter(
            (c) => c === 1
          ).length;

          if (customerChartInstance) customerChartInstance.destroy();
          customerChartInstance = new Chart(custCtx, {
            type: "bar",
            data: {
              labels: ["New Customers", "Returning Loyalists"],
              datasets: [
                {
                  label: "Customers",
                  data: [newCust, returning],
                  backgroundColor: ["#e7252d", "#116940"],
                  borderRadius: 10,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                y: { beginAtZero: true, grid: { display: false } },
                x: { grid: { display: false } },
              },
            },
          });
        }
      }

      function renderOrders() {
        let filtered = allOrders;
        if (currentView === "active")
          filtered = allOrders.filter((o) => o.status !== "Completed");
        if (currentView === "history")
          filtered = allOrders.filter((o) => o.status === "Completed");

        const tbody = $("#ordersTable").empty();
        const canManage = currentSession.role === "staff" || isManagementMode;

        filtered.forEach((o) => {
          const statusMap = {
            New: "bg-new",
            Preparing: "bg-preparing",
            "Out for Delivery": "bg-shipping",
            Completed: "bg-completed",
          };
          const items = o.items
            .map((i) => `<strong>${i.quantity}</strong>x ${i.name}`)
            .join("<br>");

          let payStatus = "";
          if (o.paymentStatus === "Successful") {
            payStatus =
              '<span class="text-success font-weight-bold">PAID</span>';
          } else {
            payStatus = `<button class="btn btn-sm btn-outline-success py-0" onclick="updateOrder('${
              o.id
            }', {paymentStatus:'Successful'})" ${
              !canManage ? "disabled" : ""
            }>Mark Paid</button>`;
          }

          let rowClass = "";
          if (o.status === "New") rowClass = "row-new";
          else if (o.status === "Preparing") rowClass = "row-preparing";
          else if (o.status === "Out for Delivery") rowClass = "row-shipping";
          else if (o.status === "Completed") rowClass = "row-completed";

          const riderOptions = allRiders
            .map(
              (r) =>
                `<option value="${r.id}" ${
                  o.assignedRiderId === r.id ? "selected" : ""
                }>${r.name}</option>`
            )
            .join("");
          const riderSelect = `
                    <div class="mt-2" style="${
                      !canManage ? "opacity: 0.6; pointer-events: none;" : ""
                    }">
                        <label class="small font-weight-bold mb-0" style="font-size: 0.65rem; color: #888; text-transform: uppercase;">Assign Rider:</label>
                        <select class="form-control form-control-sm py-0" onchange="updateOrder('${
                          o.id
                        }', {assignedRiderId: this.value})" style="font-size: 0.75rem; height: 28px; border-radius: 6px;" ${
            !canManage ? "disabled" : ""
          }>
                            <option value="">-- No Rider --</option>
                            ${riderOptions}
                        </select>
                    </div>
                `;

          tbody.append(`
                    <tr class="${rowClass}">
                        <td class="small font-weight-bold">#${o.id
                          .slice(-6)
                          .toUpperCase()}</td>
                        <td class="customer-info">
                            <div class="font-weight-bold" style="font-size: 0.9rem;">${
                              o.customerName
                            }</div>
                            <small class="d-block text-muted">
                                <i class="fas fa-map-marker-alt mr-1"></i>${
                                  o.location
                                }
                                ${
                                  o.lat
                                    ? `
                                    <a href="#" onclick="viewOrderMap(${
                                      o.lat
                                    }, ${o.lng}, '${o.customerName.replace(
                                        /'/g,
                                        "\\'"
                                      )}')" class="ml-2 text-danger font-weight-bold" style="font-size: 0.7rem; text-decoration: underline;">
                                        <i class="fas fa-external-link-alt mr-1"></i>VIEW MAP
                                    </a>
                                `
                                    : ""
                                }
                            </small>
                            <small class="d-block text-muted"><i class="fas fa-phone mr-1"></i>${
                              o.phoneNumber
                            }</small>
                            ${riderSelect}
                            ${
                              o.notes
                                ? `
                                <div class="mt-2 p-2 rounded" style="background: #fff8e1; border-left: 3px solid #ffc107; font-size: 0.75rem;">
                                    <strong class="text-warning text-uppercase" style="font-size: 0.65rem;">Special Instructions:</strong>
                                    <div class="text-dark font-italic">${o.notes}</div>
                                </div>
                            `
                                : '<div class="mt-2 small text-muted font-italic" style="font-size: 0.7rem;">None</div>'
                            }
                            <div class="mt-2">
                                <button class="btn btn-sm btn-outline-info py-0" style="font-size: 0.65rem;" onclick="promptETA('${
                                  o.id
                                }', '${o.estimatedTime || ""}')" ${
            !canManage ? "disabled" : ""
          }><i class="fas fa-clock mr-1"></i> ${
            o.estimatedTime ? "ETA: " + o.estimatedTime : "Set ETA"
          }</button>
                            </div>
                        </td>
                        <td class="small">${items}</td>
                        <td class="font-weight-bold">KES ${o.totalAmount}</td>
                        <td class="small">
                            <div class="text-muted">${new Date(
                              o.date
                            ).toLocaleTimeString([], {
                              hour: "2-digit",
                              minute: "2-digit",
                            })}</div>
                            <div class="order-age" data-date="${
                              o.date
                            }" style="margin-top: 4px;">
                                <span class="badge" style="background: ${getOrderAgeBadgeColor(
                                  o.date
                                )}; color: white; font-size: 0.65rem; padding: 4px 8px; border-radius: 8px; font-weight: 700;">${getOrderAge(
            o.date
          )}</span>
                            </div>
                        </td>
                        <td>${payStatus}</td>
                        <td><span class="status-badge ${statusMap[o.status]}">${
            o.status
          }</span></td>
                        <td>
                            <div class="d-flex" style="${
                              !canManage
                                ? "opacity: 0.4; pointer-events: none;"
                                : ""
                            }">
                                <button title="Kitchen Prep" class="btn-action btn-prep" onclick="updateOrder('${
                                  o.id
                                }', {status:'Preparing'})"><i class="fas fa-fire"></i></button>
                                <button title="Send Delivery" class="btn-action btn-ship" onclick="updateOrder('${
                                  o.id
                                }', {status:'Out for Delivery'})"><i class="fas fa-truck"></i></button>
                                <button title="Done & Print" class="btn-action btn-done" onclick="updateOrder('${
                                  o.id
                                }', {status:'Completed'}); setTimeout(() => printReceipt('${
            o.id
          }'), 500);"><i class="fas fa-check"></i></button>
                                <button title="Print Receipt" class="btn-action btn-edit" onclick="printReceipt('${
                                  o.id
                                }')" style="background: #17a2b822; color: #17a2b8;"><i class="fas fa-print"></i></button>
                                <button title="Edit Order" class="btn-action btn-edit" onclick="openEditOrder('${
                                  o.id
                                }')"><i class="fas fa-edit"></i></button>
                                <button title="Delete Record" class="btn-action btn-delete" onclick="deleteOrder('${
                                  o.id
                                }')"><i class="fas fa-trash"></i></button>
                            </div>
                            ${
                              !canManage
                                ? '<div class="small text-muted text-center mt-1"><i class="fas fa-eye mr-1"></i>Viewer Mode</div>'
                                : ""
                            }
                        </td>
                    </tr>
                `);
        });
      }

      async function updateOrder(orderId, updates) {
        try {
          const res = await adminFetch("/api/admin/order/update", {
            method: "POST",
            body: JSON.stringify({ orderId, ...updates }),
          });
          const data = await res.json();
          if (data.success) {
            showNotification(
              "Success",
              "Order updated successfully",
              "success"
            );
            loadData();
          }
        } catch (e) {
          console.error(e);
        }
      }

      async function deleteOrder(orderId) {
        if (!confirm("Delete this order permanently?")) return;
        try {
          const res = await adminFetch("/api/admin/order/delete", {
            method: "POST",
            body: JSON.stringify({ orderId }),
          });
          const data = await res.json();
          if (data.success) {
            showNotification("Deleted", "Order has been removed", "success");
            loadData();
          } else {
            alert("Error: " + data.message);
          }
        } catch (e) {
          console.error(e);
        }
      }

      function promptETA(orderId, current) {
        $("#etaOrderId").val(orderId);
        $("#customETA").val(current || "");
        $("#quickETAModal").modal("show");
      }

      function selectETA(time) {
        const orderId = $("#etaOrderId").val();
        updateOrder(orderId, { estimatedTime: time });
        $("#quickETAModal").modal("hide");
      }

      function saveCustomETA() {
        const orderId = $("#etaOrderId").val();
        const time = $("#customETA").val();
        if (time) {
          updateOrder(orderId, { estimatedTime: time });
          $("#quickETAModal").modal("hide");
        } else {
          alert("Please enter a time or pick an option");
        }
      }

      function printReceipt(orderId) {
        const o = allOrders.find((ord) => ord.id === orderId);
        if (!o) return;

        const printWindow = window.open("", "_blank", "width=400,height=600");
        const itemsHtml = o.items
          .map(
            (i) => `
                <tr>
                    <td style="padding: 5px 0;">${i.name} x ${i.quantity}</td>
                    <td style="text-align: right;">KES ${
                      i.price * i.quantity
                    }</td>
                </tr>
            `
          )
          .join("");

        const receiptHtml = `
                <html>
                <head>
                    <title>Receipt #${o.id.slice(-6).toUpperCase()}</title>
                    <style>
                        body { font-family: 'Courier New', Courier, monospace; padding: 20px; color: #333; font-size: 12px; line-height: 1.2; }
                        .header { text-align: center; margin-bottom: 20px; }
                        .divider { border-top: 1px dashed #000; margin: 10px 0; }
                        table { width: 100%; border-collapse: collapse; }
                        .total { font-weight: bold; font-size: 14px; }
                        .footer { text-align: center; margin-top: 30px; font-size: 10px; }
                    </style>
                </head>
                <body onload="setTimeout(() => { window.print(); window.close(); }, 500);">
                    <div class="header">
                        <h2 style="margin:0;">KIBBY'S HOT KITCHEN</h2>
                        <p style="margin:5px 0;">Ndichu Container, Room 7<br>USIU Road, Nairobi</p>
                    </div>
                    <div>
                        <strong>Order Ref:</strong> #${o.id
                          .slice(-6)
                          .toUpperCase()}<br>
                        <strong>Date:</strong> ${new Date(
                          o.date
                        ).toLocaleString()}<br>
                        <strong>Customer:</strong> ${o.customerName}<br>
                        <strong>Phone:</strong> ${o.phoneNumber}
                    </div>
                    <div class="divider"></div>
                    <table>${itemsHtml}</table>
                    <div class="divider"></div>
                    <div class="total">
                        <div style="display:flex; justify-content:space-between;">
                            <span>SUBTOTAL:</span>
                            <span>KES ${(
                              parseInt(o.totalAmount) +
                              (parseInt(o.discountAmount) || 0)
                            ).toLocaleString()}</span>
                        </div>
                        ${
                          o.discountAmount
                            ? `
                        <div style="display:flex; justify-content:space-between; color: #666; font-size: 11px;">
                            <span>DISCOUNT (${o.promoCode || "PROMO"}):</span>
                            <span>-KES ${parseInt(
                              o.discountAmount
                            ).toLocaleString()}</span>
                        </div>
                        `
                            : ""
                        }
                        <div style="display:flex; justify-content:space-between; font-size: 16px; margin-top: 10px;">
                            <span>TOTAL:</span>
                            <span>KES ${parseInt(
                              o.totalAmount
                            ).toLocaleString()}</span>
                        </div>
                    </div>
                    <div class="divider"></div>
                    <div class="footer">
                        THANK YOU FOR YOUR ORDER!<br>
                        We hope to serve you again soon.
                    </div>
                </body>
                </html>
            `;

        printWindow.document.write(receiptHtml);
        printWindow.document.close();
      }

      function sendWhatsApp(orderId) {
        const o = allOrders.find((ord) => ord.id === orderId);
        if (!o) return;

        let msg = "";
        const ref = o.id.slice(-6).toUpperCase();
        if (o.status === "New")
          msg = `Hi ${o.customerName}, Kibby's Hot Kitchen has received your order #${ref}. We'll start preparing it shortly! `;
        else if (o.status === "Preparing")
          msg = `Hi ${o.customerName}, your Kibby's order #${ref} is now being prepared! `;
        else if (o.status === "Out for Delivery")
          msg = `Hi ${o.customerName}, your Kibby's order #${ref} is out for delivery!  Expect it soon.`;
        else if (o.status === "Completed")
          msg = `Hi ${o.customerName}, your order #${ref} has been delivered. Enjoy your meal! `;
        else msg = `Hi ${o.customerName}, regarding your Kibby's order #${ref}...`;

        const phone = o.phoneNumber.replace(/^0/, "254");
        const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
        window.open(url, "_blank");
      }

      function openEditOrder(orderId) {
        const o = allOrders.find((ord) => ord.id === orderId);
        if (!o) return;

        const form = $("#editOrderForm")[0];
        form.orderId.value = o.id;
        form.customerName.value = o.customerName;
        form.phoneNumber.value = o.phoneNumber;
        form.location.value = o.location;
        form.totalAmount.value = o.totalAmount;
        form.paymentStatus.value = o.paymentStatus || "Pending";
        if (form.estimatedTime)
          form.estimatedTime.value = o.estimatedTime || "";

        $("#editOrderModal").modal("show");
      }

      let adminMap;
      function viewOrderMap(lat, lng, name) {
        $("#orderMapModal").modal("show");
        $("#mapModalTitle").text(`Location for ${name}`);

        $("#mapDirectionsLink").html(`
                <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}" target="_blank" class="btn btn-primary btn-block py-3" style="border-radius: 12px; font-weight: 800;">
                    <i class="fas fa-directions mr-2"></i> GET GOOGLE MAPS DIRECTIONS
                </a>
            `);

        setTimeout(() => {
          if (adminMap) adminMap.remove();
          adminMap = L.map("orderMapView").setView([lat, lng], 17);
          L.tileLayer(
            "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
          ).addTo(adminMap);
          L.marker([lat, lng], {
            icon: L.icon({
              iconUrl:
                "https://cdn0.iconfinder.com/data/icons/small-n-flat/24/678111-map-marker-512.png",
              iconSize: [40, 40],
              iconAnchor: [20, 40],
            }),
          })
            .addTo(adminMap)
            .bindPopup(`<b>${name}'s Location</b>`)
            .openPopup();
        }, 500);
      }

      $("#editOrderForm").submit(async (e) => {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));

        // Clean up empty strings
        if (!data.estimatedTime) delete data.estimatedTime;

        await adminFetch("/api/admin/order/update", {
          method: "POST",
          body: JSON.stringify(data),
        });
        $("#editOrderModal").modal("hide");
        loadData();
      });

      // Menu Management
      let menuCache = [];
      async function loadMenu() {
        const res = await fetch("/api/menu?_=" + new Date().getTime());
        menuCache = await res.json();
        renderMenuTable();
      }

      function renderMenuTable() {
        const searchTerm = ($("#menuSearch").val() || "").toLowerCase();
        const tbody = $("#menuTableBody").empty();

        const filtered = menuCache.filter(
          (item) =>
            item.name.toLowerCase().includes(searchTerm) ||
            item.category.toLowerCase().includes(searchTerm)
        );

        filtered.forEach((item) => {
          const checked = item.isAvailable !== false ? "checked" : "";
          tbody.append(`
                    <tr>
                        <td>${item.id}</td>
                        <td><img src="../${
                          item.image
                        }" style="width: 40px; border-radius: 8px; height: 40px; object-fit: cover;"></td>
                        <td>
                            <div class="font-weight-bold">${item.name}</div>
                            <small class="text-muted">${item.tag || ""}</small>
                        </td>
                        <td><span class="badge badge-light p-2">${
                          item.category
                        }</span></td>
                        <td>KES ${item.price}</td>
                        <td class="text-center">
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary" onclick="openEditMenu(${
                                  item.id
                                })"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteMenuItem(${
                                  item.id
                                })"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>
                `);
        });
      }

      async function toggleAvailability(id) {
        try {
          const res = await adminFetch("/api/admin/menu/toggle-availability", {
            method: "POST",
            body: JSON.stringify({ id }),
          });
          const data = await res.json();
          if (data.success) {
            showNotification(
              "Status Updated",
              "Item availability changed",
              "success"
            );
          }
        } catch (e) {
          console.error(e);
          loadMenu(); // Refresh on error
        }
      }

      async function openEditMenu(id) {
        const item = menuCache.find((m) => m.id == id);
        if (!item) return;

        // Load categories into dropdown
        const settingsRes = await fetch(
          "/api/settings?_=" + new Date().getTime()
        );
        const settings = await settingsRes.json();
        const dropdown = $("#editMenuCategoryDropdown").empty();
        (settings.menuCategories || []).forEach((cat) => {
          dropdown.append(`<option value="${cat.id}">${cat.name}</option>`);
        });

        const form = $("#editMenuForm")[0];
        form.id.value = item.id;
        form.name.value = item.name;
        form.price.value = item.price;
        form.category.value = item.category;
        form.tag.value = item.tag || "";

        $("#editMenuModal").modal("show");
      }

      $("#editMenuForm").submit(async (e) => {
        e.preventDefault();
        const btn = $(e.target).find('button[type="submit"]');
        btn.text("Saving...").prop("disabled", true);

        const formData = new FormData(e.target);
        try {
          const res = await adminFetch("/api/admin/menu/update", {
            method: "POST",
            body: formData,
          });
          const data = await res.json();
          if (data.success) {
            $("#editMenuModal").modal("hide");
            showNotification("Updated", "Menu item saved", "success");
            loadMenu();
          }
        } catch (err) {
          console.error(err);
          alert("Update failed");
        } finally {
          btn.text("Save Changes").prop("disabled", false);
        }
      });

      $("#addMenuForm").submit(async (e) => {
        e.preventDefault();
        const btn = $(e.target).find('button[type="submit"]');
        btn.text("Uploading...").prop("disabled", true);

        const formData = new FormData(e.target);
        try {
          const res = await adminFetch("/api/admin/menu/add", {
            method: "POST",
            body: formData, // No headers needed for FormData
          });
          const data = await res.json();
          if (data.success) {
            $("#addMenuModal").modal("hide");
            e.target.reset();
            $(".custom-file-label").text("Choose file");
            loadMenu();
          }
        } catch (err) {
          console.error(err);
          alert("Upload failed");
        } finally {
          btn.text("Upload & Add to Menu").prop("disabled", false);
        }
      });

      async function deleteMenuItem(id) {
        if (!confirm("Delete this menu item?")) return;
        try {
          const res = await adminFetch("/api/admin/menu/delete", {
            method: "POST",
            body: JSON.stringify({ id: String(id) }),
          });
          const data = await res.json();
          if (data.success) {
            showNotification("Deleted", "Menu item removed", "success");
            loadMenu();
          }
        } catch (e) {
          console.error(e);
        }
      }

      async function loadSettings() {
        try {
          const res = await fetch("/api/settings?_=" + new Date().getTime());
          const data = await res.json();

          // Helper to safely execute blocks
          const tryBlock = (fn, name) => {
            try {
              fn();
            } catch (e) {
              console.error(`Error in ${name}:`, e);
            }
          };

          // Load Website Core Info
          tryBlock(() => {
            const form = $("#settingsForm")[0];
            if (form) {
              const phoneFields = $("#phoneFields");
              phoneFields.empty();
              const phones =
                data.supportPhones ||
                (data.supportPhone ? [data.supportPhone] : [""]);
              phones.forEach((phone) => {
                phoneFields.append(`
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control" name="supportPhones[]" value="${phone}" placeholder="e.g. 0712345678">
                                    <div class="input-group-append">
                                        <button type="button" class="btn btn-outline-danger" onclick="$(this).closest('.input-group').remove()"><i class="fas fa-times"></i></button>
                                    </div>
                                </div>
                            `);
              });

              const emailFields = $("#emailFields");
              emailFields.empty();
              const emails =
                data.supportEmails ||
                (data.supportEmail ? [data.supportEmail] : [""]);
              emails.forEach((email) => {
                emailFields.append(`
                                <div class="input-group mb-2">
                                    <input type="email" class="form-control" name="supportEmails[]" value="${email}" placeholder="e.g. support@pcnc.com">
                                    <div class="input-group-append">
                                        <button type="button" class="btn btn-outline-danger" onclick="$(this).closest('.input-group').remove()"><i class="fas fa-times"></i></button>
                                    </div>
                                </div>
                            `);
              });

              if (form.homeTitle) form.homeTitle.value = data.homeTitle || "";
              if (form.homeSubtext)
                form.homeSubtext.value = data.homeSubtext || "";
              if (form.aboutText) form.aboutText.value = data.aboutText || "";
              $("#globalWhatsappInput").val(data.whatsappNumber || "");
            }
          }, "CoreInfo");

          // Load Deal of the Week
          tryBlock(() => {
            const df = $("#dealForm")[0];
            if (df && data.dealOfWeek) {
              if (df.title) df.title.value = data.dealOfWeek.title || "";
              if (df.subtitle)
                df.subtitle.value = data.dealOfWeek.subtitle || "";
              if (df.description)
                df.description.value = data.dealOfWeek.description || "";
              if (df.image) df.image.value = data.dealOfWeek.image || "";
            }
          }, "DealOfWeek");

          // Load Home About
          tryBlock(() => {
            const haf = $("#homeAboutForm")[0];
            if (haf && data.homeAbout) {
              if (haf.title) haf.title.value = data.homeAbout.title || "";
              if (haf.heading) haf.heading.value = data.homeAbout.heading || "";
              if (haf.description)
                haf.description.value = data.homeAbout.description || "";
              if (haf.videoLink)
                haf.videoLink.value = data.homeAbout.videoLink || "";
              if (haf.isVideoLocal)
                haf.isVideoLocal.checked = data.homeAbout.isVideoLocal || false;
              if (haf.abtImage)
                haf.abtImage.value = data.homeAbout.abtImage || "";
            }
          }, "HomeAbout");

          // Load About Promo
          tryBlock(() => {
            const apf = $("#aboutPromoForm")[0];
            if (apf && data.aboutPromo) {
              if (apf.line1) apf.line1.value = data.aboutPromo.line1 || "";
              if (apf.line2) apf.line2.value = data.aboutPromo.line2 || "";
            }
          }, "AboutPromo");

          // Load Promos
          tryBlock(() => renderPromos(data.promoCodes || []), "Promos");

          // Load Riders
          tryBlock(() => {
            allRiders = data.riders || [];
            renderRiders();
          }, "Riders");

          // Load Team
          tryBlock(() => {
            const tbody = $("#teamTableBody").empty();
            const teamData = data.team || [];
            if (teamData.length > 0) {
              teamData.forEach((m) => {
                tbody.append(`
                                <tr>
                                    <td><img src="../${
                                      m.image
                                    }" style="width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid #eee;"></td>
                                    <td><div class="font-weight-bold" style="color: #1a1a1a;">${
                                      m.name
                                    }</div><small class="text-danger font-weight-bold" style="text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.5px;">${
                  m.role
                }</small></td>
                                    <td class="small font-weight-bold">${
                                      m.phone ||
                                      '<span class="text-muted font-italic">No Phone Recorded</span>'
                                    }</td>
                                    <td class="text-right">
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-light text-primary" onclick="openEditTeamMember(${
                                              m.id
                                            })"><i class="fas fa-edit"></i></button>
                                            <button class="btn btn-sm btn-light text-danger" onclick="deleteTeamMember(${
                                              m.id
                                            })"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </td>
                                </tr>
                            `);
              });
            } else {
              tbody.append(
                '<tr><td colspan="3" class="text-center text-muted">No team members yet</td></tr>'
              );
            }
          }, "Team");

          // Load Categories
          tryBlock(() => {
            const catBody = $("#categoryTableBody").empty();
            const catDropdown = $("#addMenuCategoryDropdown");
            const catData = data.menuCategories || [];

            if (catData.length > 0) {
              if (catDropdown.length > 0) catDropdown.empty();
              catData.forEach((cat) => {
                catBody.append(`
                                <tr>
                                    <td><code>${cat.id}</code></td>
                                    <td>${cat.name}</td>
                                    <td class="text-right">
                                        <button class="btn btn-sm btn-outline-primary mr-1" onclick="openEditCategory('${cat.id}')"><i class="fas fa-edit"></i></button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory('${cat.id}')"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            `);
                if (catDropdown.length > 0)
                  catDropdown.append(
                    `<option value="${cat.id}">${cat.name}</option>`
                  );
              });
            } else {
              catBody.append(
                '<tr><td colspan="3" class="text-center text-muted">No categories available</td></tr>'
              );
              if (catDropdown.length > 0) {
                catDropdown.empty();
                catDropdown.append(
                  '<option value="">No categories available</option>'
                );
              }
            }
          }, "Categories");

          // Load Staff Accounts
          tryBlock(() => {
            const container = $("#staffLoginsContainer").empty();
            const staff = data.staffLogins || [
              {
                id: 1,
                username: "admin1",
                password: "admin123",
                name: "JOHN WAINAINA",
              },
              {
                id: 2,
                username: "admin2",
                password: "pcnc2026",
                name: "HARRY MOKAYA",
              },
            ];
            staff.forEach((s) => {
              container.append(`
                            <div class="col-md-6 mb-3">
                                <div class="p-4 border rounded shadow-sm" style="background: #fdfdfd; border-radius: 15px !important;">
                                    <h6 class="font-weight-bold mb-3 text-danger"><i class="fas fa-user-lock mr-2"></i> Account ${s.id} Access</h6>
                                    <div class="form-group">
                                        <label class="small font-weight-bold">Assigned Staff Name</label>
                                        <input type="text" name="staff${s.id}_name" class="form-control" value="${s.name}" placeholder="e.g. Anthony" required>
                                        <small class="text-muted">Must start with a capital letter</small>
                                    </div>
                                    <div class="form-group">
                                        <label class="small font-weight-bold">Internal Username</label>
                                        <input type="text" name="staff${s.id}_user" class="form-control" value="${s.username}" required>
                                    </div>
                                    <div class="form-group mb-0">
                                        <label class="small font-weight-bold">Access Key (Password)</label>
                                        <div class="input-group">
                                            <input type="password" name="staff${s.id}_pass" class="form-control" value="${s.password}" required>
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary" type="button" onclick="this.parentElement.previousElementSibling.type = this.parentElement.previousElementSibling.type === 'password' ? 'text' : 'password'"><i class="fas fa-eye"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `);
            });
          }, "StaffLogins");

          if (allOrders.length > 0) renderOrders();
        } catch (e) {
          console.error("CRITICAL Error loading settings:", e);
          alert(
            "Connection to server settings failed. Please check your internet or reload."
          );
        }
      }

      function addPhoneField() {
        $("#phoneFields").append(`
                <div class="input-group mb-2">
                    <input type="text" class="form-control" name="supportPhones[]" placeholder="e.g. 0712345678">
                    <div class="input-group-append">
                        <button type="button" class="btn btn-outline-danger" onclick="$(this).closest('.input-group').remove()"><i class="fas fa-times"></i></button>
                    </div>
                </div>
            `);
      }

      function addEmailField() {
        $("#emailFields").append(`
                <div class="input-group mb-2">
                    <input type="email" class="form-control" name="supportEmails[]" placeholder="e.g. support@pcnc.com">
                    <div class="input-group-append">
                        <button type="button" class="btn btn-outline-danger" onclick="$(this).closest('.input-group').remove()"><i class="fas fa-times"></i></button>
                    </div>
                </div>
            `);
      }

      $("#addTeamForm").submit(async (e) => {
        e.preventDefault();
        const btn = $(e.target).find('button[type="submit"]');
        btn.text("Uploading...").prop("disabled", true);
        const formData = new FormData(e.target);
        try {
          const res = await adminFetch("/api/admin/team/add", {
            method: "POST",
            body: formData,
          });
          if (res.ok) {
            $("#addTeamModal").modal("hide");
            e.target.reset();
            loadSettings();
            showNotification(
              "Team Updated",
              "New member added successfully",
              "success"
            );
          }
        } catch (err) {
          console.error(err);
        } finally {
          btn.text("Upload & Add Member").prop("disabled", false);
        }
      });

      async function deleteTeamMember(id) {
        if (!confirm("Remove this team member?")) return;
        try {
          await adminFetch("/api/admin/team/delete", {
            method: "POST",
            body: JSON.stringify({ id }),
          });
          loadSettings();
          showNotification("Member Removed", "Team list updated", "success");
        } catch (e) {
          console.error(e);
        }
      }

      function openEditTeamMember(id) {
        fetch("/api/settings?_=" + new Date().getTime())
          .then((res) => res.json())
          .then((data) => {
            const m = data.team.find((member) => member.id == id);
            if (!m) return;
            const form = $("#editTeamForm")[0];
            form.id.value = m.id;
            form.name.value = m.name;
            form.role.value = m.role;
            form.phone.value = m.phone || "";
            form.facebook.value = m.facebook || "";
            form.twitter.value = m.twitter || "";
            form.instagram.value = m.instagram || "";
            form.linkedin.value = m.linkedin || "";
            $("#editTeamModal").modal("show");
          });
      }

      $("#editTeamForm").submit(async (e) => {
        e.preventDefault();
        const btn = $(e.target).find('button[type="submit"]');
        btn.text("Saving...").prop("disabled", true);
        const formData = new FormData(e.target);
        try {
          const res = await adminFetch("/api/admin/team/update", {
            method: "POST",
            body: formData,
          });
          if (res.ok) {
            $("#editTeamModal").modal("hide");
            loadSettings();
            showNotification("Updated", "Team member details saved", "success");
          }
        } catch (err) {
          console.error(err);
        } finally {
          btn.text("Save Changes").prop("disabled", false);
        }
      });

      $("#addRiderForm").submit(async (e) => {
        e.preventDefault();
        const btn = $(e.target).find('button[type="submit"]');
        btn.text("Registering...").prop("disabled", true);
        const formData = new FormData(e.target);
        try {
          const res = await adminFetch("/api/admin/riders/add", {
            method: "POST",
            body: formData,
          });
          if (res.ok) {
            $("#addRiderModal").modal("hide");
            e.target.reset();
            loadSettings();
            showNotification("Rider Added", "Delivery team updated", "success");
          } else {
            const errData = await res.json();
            alert("Error: " + (errData.message || "Failed to register rider"));
          }
        } catch (err) {
          console.error(err);
          alert("Connection error. Please try again.");
        } finally {
          btn.text("Register Rider").prop("disabled", false);
        }
      });

      async function deleteRider(id) {
        if (!confirm("Remove this dispatch rider?")) return;
        try {
          await adminFetch("/api/admin/riders/delete", {
            method: "POST",
            body: JSON.stringify({ id }),
          });
          loadSettings();
          showNotification("Rider Removed", "Delivery team updated", "success");
        } catch (e) {
          console.error(e);
        }
      }

      function openEditRider(id) {
        const r = allRiders.find((rider) => rider.id == id);
        if (!r) return;
        const form = $("#editRiderForm")[0];
        form.id.value = r.id;
        form.name.value = r.name;
        form.phone.value = r.phone;
        form.vehicle.value = r.vehicle || "";
        $("#editRiderModal").modal("show");
      }

      $("#editRiderForm").submit(async (e) => {
        e.preventDefault();
        const btn = $(e.target).find('button[type="submit"]');
        btn.text("Saving...").prop("disabled", true);
        const formData = new FormData(e.target);
        try {
          const res = await adminFetch("/api/admin/riders/update", {
            method: "POST",
            body: formData,
          });
          if (res.ok) {
            $("#editRiderModal").modal("hide");
            loadSettings();
            showNotification("Updated", "Rider details saved", "success");
          }
        } catch (err) {
          console.error(err);
        } finally {
          btn.text("Save Changes").prop("disabled", false);
        }
      });

      $("#addCategoryForm").submit(async (e) => {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        try {
          const res = await adminFetch("/api/admin/category/add", {
            method: "POST",
            body: JSON.stringify(data),
          });
          if (res.ok) {
            $("#addCategoryModal").modal("hide");
            e.target.reset();
            loadSettings();
            showNotification(
              "Category Added",
              "Menu flavors updated",
              "success"
            );
          }
        } catch (err) {
          console.error(err);
        }
      });

      async function deleteCategory(id) {
        if (
          !confirm(
            "Delete this category? Menu items with this category will still exist."
          )
        )
          return;
        try {
          await adminFetch("/api/admin/category/delete", {
            method: "POST",
            body: JSON.stringify({ id }),
          });
          loadSettings();
          showNotification(
            "Category Deleted",
            "Menu flavors updated",
            "success"
          );
        } catch (e) {
          console.error(e);
        }
      }

      function openEditCategory(id) {
        fetch("/api/settings?_=" + new Date().getTime())
          .then((res) => res.json())
          .then((data) => {
            const cat = data.menuCategories.find((c) => c.id === id);
            if (!cat) return;
            const form = $("#editCategoryForm")[0];
            form.oldId.value = cat.id;
            form.catId.value = cat.id;
            form.catName.value = cat.name;
            $("#editCategoryModal").modal("show");
          });
      }

      $("#editCategoryForm").submit(async (e) => {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        try {
          const res = await adminFetch("/api/admin/category/update", {
            method: "POST",
            body: JSON.stringify(data),
          });
          if (res.ok) {
            $("#editCategoryModal").modal("hide");
            loadSettings();
            showNotification("Updated", "Category details saved", "success");
          }
        } catch (err) {
          console.error(err);
        }
      });

      async function downloadReport() {
        // Check first order time for 24h rule
        if (allOrders.length === 0) {
          alert("No orders found to export");
          return;
        }
        const token = localStorage.getItem("adminToken");
        window.open(`/api/admin/export?token=${token}`, "_blank");
      }

      $("#settingsForm").submit(async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);

        // Extract arrays for phones and emails
        const supportPhones = formData
          .getAll("supportPhones[]")
          .filter((p) => p.trim() !== "");
        const supportEmails = formData
          .getAll("supportEmails[]")
          .filter((e) => e.trim() !== "");

        const data = {
          supportPhones,
          supportEmails,
          homeTitle: formData.get("homeTitle"),
          homeSubtext: formData.get("homeSubtext"),
          aboutText: formData.get("aboutText"),
        };

        const res = await adminFetch("/api/admin/settings/update", {
          method: "POST",
          body: JSON.stringify(data),
        });
        const resData = await res.json();
        if (resData.success) {
          showNotification("Updated", "System settings saved", "success");
        }
      });

      $("#dealForm").submit(async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const dealData = Object.fromEntries(formData);

        // Handle Image Upload if selected
        const fileInput = $("#dealImageInput")[0].files[0];
        if (fileInput) {
          const uploadData = new FormData();
          uploadData.append("mediaFile", fileInput);
          const uploadRes = await adminFetch("/api/admin/settings/upload", {
            method: "POST",
            body: uploadData,
          });
          const uploadResult = await uploadRes.json();
          if (uploadResult.success) dealData.image = uploadResult.filePath;
        }

        const res = await adminFetch("/api/admin/settings/update", {
          method: "POST",
          body: JSON.stringify({ dealOfWeek: dealData }),
        });
        if (res.ok)
          showNotification("Updated", "Deal of the week saved", "success");
      });

      $("#homeAboutForm").submit(async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const aboutData = Object.fromEntries(formData);
        aboutData.isVideoLocal = formData.get("isVideoLocal") === "on";

        // Handle Image Upload if selected
        const fileInput = $("#homeAboutImageInput")[0].files[0];
        if (fileInput) {
          const uploadData = new FormData();
          uploadData.append("mediaFile", fileInput);
          const uploadRes = await adminFetch("/api/admin/settings/upload", {
            method: "POST",
            body: uploadData,
          });
          const uploadResult = await uploadRes.json();
          if (uploadResult.success) aboutData.abtImage = uploadResult.filePath;
        }

        const res = await adminFetch("/api/admin/settings/update", {
          method: "POST",
          body: JSON.stringify({ homeAbout: aboutData }),
        });
        if (res.ok)
          showNotification("Updated", "Home About section saved", "success");
      });

      $("#videoUpload").change(async function () {
        const file = this.files[0];
        if (!file) return;

        const uploadData = new FormData();
        uploadData.append("mediaFile", file);

        showNotification(
          "Uploading...",
          "Please wait for the video to upload",
          "info"
        );

        const res = await adminFetch("/api/admin/settings/upload", {
          method: "POST",
          body: uploadData,
        });
        const data = await res.json();
        if (data.success) {
          $('[name="videoLink"]').val(data.filePath);
          $("#isVideoLocal").prop("checked", true);
          showNotification("Success", "Video uploaded successfully", "success");
        }
      });

      $("#aboutPromoForm").submit(async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const promoData = Object.fromEntries(formData);

        const res = await adminFetch("/api/admin/settings/update", {
          method: "POST",
          body: JSON.stringify({ aboutPromo: promoData }),
        });
        if (res.ok)
          showNotification("Updated", "About Promo section saved", "success");
      });

      function renderPromos(promos) {
        const tbody = $("#promoTableBody").empty();
        if (promos.length === 0) {
          tbody.append(
            '<tr><td colspan="3" class="text-center text-muted">No codes yet</td></tr>'
          );
          return;
        }
        promos.forEach((p) => {
          tbody.append(`
                    <tr>
                        <td><strong class="text-danger">${p.code}</strong></td>
                        <td>${p.discount}% Off</td>
                        <td class="text-right">
                            <button class="btn btn-sm btn-outline-danger" onclick="deletePromo('${p.code}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `);
        });
      }

      $("#addPromoForm").submit(async (e) => {
        e.preventDefault();
        const btn = $(e.target).find('button[type="submit"]');
        const originalText = btn.text();

        try {
          btn.text("Creating...").prop("disabled", true);
          const data = Object.fromEntries(new FormData(e.target));

          const res = await adminFetch("/api/admin/promo/add", {
            method: "POST",
            body: JSON.stringify(data),
          });

          const result = await res.json();

          if (res.ok && result.success) {
            $("#addPromoModal").modal("hide");
            e.target.reset();
            loadSettings();
            showNotification(
              "Code Created",
              "Promo code is now active",
              "success"
            );
          } else {
            showNotification(
              "Failed",
              result.message || "Could not create code",
              "error"
            );
          }
        } catch (err) {
          console.error("Promo Add Error:", err);
          showNotification("Error", "Server communication failed", "error");
        } finally {
          btn.text(originalText).prop("disabled", false);
        }
      });

      async function deletePromo(code) {
        if (!confirm("Delete this promo code?")) return;
        const res = await fetch("/api/admin/promo/delete", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ code }),
        });
        if (res.ok) {
          loadSettings();
          showNotification("Deleted", "Promo code removed", "success");
        }
      }

      async function triggerBackup() {
        showNotification("Backing up...", "Creating system snapshot", "info");
        try {
          const res = await fetch("/api/admin/backup", { method: "POST" });
          const data = await res.json();
          if (data.success) {
            showNotification(
              "Backup Success",
              "Snapshot created in /backups folder",
              "success"
            );
          }
        } catch (e) {
          console.error(e);
        }
      }

      // Mobile Menu Toggle Function
      function toggleMobileMenu() {
        const sidebar = document.querySelector(".sidebar");
        const overlay = document.querySelector(".sidebar-overlay");

        sidebar.classList.toggle("active");
        overlay.classList.toggle("active");
      }

      // Close mobile menu when clicking on a nav item
      document.querySelectorAll(".sidebar a").forEach((link) => {
        link.addEventListener("click", () => {
          if (window.innerWidth <= 991) {
            toggleMobileMenu();
          }
        });
      });

      $("#staffSettingsForm").submit(async (e) => {
        e.preventDefault();
        const btn = $(e.target).find('button[type="submit"]');
        btn.text("Saving Securely...").prop("disabled", true);

        const staff1 = {
          id: 1,
          username: $('[name="staff1_user"]').val(),
          password: $('[name="staff1_pass"]').val(),
          name: $('[name="staff1_name"]').val(),
        };
        const staff2 = {
          id: 2,
          username: $('[name="staff2_user"]').val(),
          password: $('[name="staff2_pass"]').val(),
          name: $('[name="staff2_name"]').val(),
        };

        try {
          const res = await adminFetch("/api/admin/settings/update", {
            method: "POST",
            body: JSON.stringify({ staffLogins: [staff1, staff2] }),
          });
          if (res.ok) {
            showNotification(
              "Security Updated",
              "Staff access permissions saved",
              "success"
            );
          }
        } catch (e) {
          console.error(e);
          showNotification(
            "Error",
            "Failed to update security settings",
            "error"
          );
        } finally {
          btn.text("SAVE ACCESS PERMISSIONS").prop("disabled", false);
        }
      });

      setInterval(loadData, 10000);
      loadData();

      // Update active sessions display on load and every 3 seconds
      updateActiveSessionsDisplay();
      setInterval(updateActiveSessionsDisplay, 3000);
    </script>
  </body>
</html>
