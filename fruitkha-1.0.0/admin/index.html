<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kibby's Hot Kitchen | Portal Login</title>
    <link rel="stylesheet" href="../assets/bootstrap/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        :root {
            --kibbys-red: #c11b17;
            --pcnc-dark: #1a1a1a;
            --glass: rgba(255, 255, 255, 0.85); /* Slightly more transparent */
        }
        body { 
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
            font-family: 'Outfit', sans-serif;
            min-height: 100vh; /* Changed from height: 100vh to prevent overlap */
            display: flex; 
            align-items: center; 
            justify-content: center;
            padding: 40px 20px; /* Added padding for mobile breathing room */
            overflow-x: hidden;
            overflow-y: auto; /* Allow scroll if content exceeds viewport */
        }
        
        /* Animated Background Gradients */
        .aurora {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            filter: blur(100px);
            opacity: 0.3;
        }
        .aurora-1 { width: 400px; height: 400px; background: var(--kibbys-red); top: -100px; right: -100px; border-radius: 50%; animation: drift 15s infinite alternate; }
        .aurora-2 { width: 500px; height: 500px; background: #a11612; bottom: -150px; left: -150px; border-radius: 50%; animation: drift 20s infinite alternate-reverse; }
        
        @keyframes drift {
            from { transform: translate(0, 0) scale(1); }
            to { transform: translate(50px, 50px) scale(1.1); }
        }

        .login-box { 
            background: var(--glass);
            backdrop-filter: blur(25px);
            padding: 40px; /* Slightly reduced padding */
            border-radius: 40px; 
            box-shadow: 0 40px 120px rgba(0,0,0,0.6); 
            width: 100%; 
            max-width: 480px; 
            border: 1px solid rgba(255,255,255,0.4);
            position: relative;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .login-box:hover { transform: translateY(-5px); }
        
        .logo-area { text-align: center; margin-bottom: 30px; }
        .logo-area img { max-height: 80px; filter: drop-shadow(0 10px 20px rgba(193, 27, 23, 0.3)); transition: 0.3s; }
        .logo-area img:hover { transform: scale(1.05) rotate(2deg); }
        
        .nav-pills { background: rgba(0,0,0,0.05); padding: 5px; border-radius: 20px; border: 1px solid rgba(0,0,0,0.05); }
        .nav-pills .nav-link { 
            color: #666; font-weight: 700; font-size: 0.8rem; text-transform: uppercase; 
            letter-spacing: 1px; border-radius: 16px; transition: 0.3s;
        }
        .nav-pills .nav-link.active { background: var(--kibbys-red); color: white; box-shadow: 0 5px 15px rgba(193, 27, 23, 0.3); }

        .form-group label { 
            font-weight: 700; color: #444; font-size: 0.7rem; 
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;
            padding-left: 5px;
        }
        
        .form-control {
            border-radius: 18px; padding: 14px 20px; border: 2px solid #eee;
            background: rgba(255,255,255,0.8); font-size: 0.95rem; transition: 0.3s;
            height: auto;
        }
        .form-control:focus {
            border-color: var(--kibbys-red); background: #fff; box-shadow: 0 0 0 5px rgba(193, 27, 23, 0.1);
        }
        
        .btn-orange { 
            background: linear-gradient(135deg, var(--kibbys-red) 0%, #a11612 100%); 
            color: white; border: none; padding: 18px; border-radius: 20px;
            font-weight: 800; text-transform: uppercase; letter-spacing: 2px;
            transition: 0.4s; margin-top: 10px;
        }
        .btn-orange:hover { transform: scale(1.02); box-shadow: 0 15px 35px rgba(193, 27, 23, 0.4); color: white; }
        
        .custom-file-label { border-radius: 18px; padding: 14px 20px; border: 2px solid #eee; height: auto; background: rgba(255,255,255,0.8); }
        .custom-file-label::after { border-radius: 0 16px 16px 0; padding: 14px 20px; height: auto; background: #f0f0f0; }

        .admin-footer { margin-top: 30px; font-size: 0.7rem; color: #aaa; text-align: center; font-weight: 600; letter-spacing: 0.5px; }
        
        #previewArea img {
            width: 90px; height: 90px; border-radius: 50%; object-fit: cover;
            border: 4px solid var(--kibbys-red); margin: 0 auto 20px; display: block;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        /* Responsive Fixes */
        @media (max-height: 850px) {
            .login-box { padding: 30px 25px; margin: 20px 0; }
            .logo-area { margin-bottom: 20px; }
            .logo-area img { max-height: 60px; }
        }
    </style>
</head>
<body>
    <div class="aurora"><div class="aurora-1"></div><div class="aurora-2"></div></div>

    <div class="login-box animate__animated animate__fadeIn">
        <div class="logo-area">
            <img src="../assets/img/kibbys-logo.png" alt="Kibby's Hot Kitchen Logo">
            <h4 class="mt-3 font-weight-bold" style="letter-spacing: -0.5px; color: var(--pcnc-dark);">Kibby's Hot Kitchen Portal</h4>
            <p class="text-muted small">Restricted access for authorized personnel</p>
        </div>

        <ul class="nav nav-pills nav-justified mb-4" id="pills-tab" role="tablist">
            <li class="nav-item"><a class="nav-link active" id="pills-login-tab" data-toggle="pill" href="#pills-login" role="tab">Sign In</a></li>
            <li class="nav-item"><a class="nav-link" id="pills-signup-tab" data-toggle="pill" href="#pills-signup" role="tab">Apply</a></li>
        </ul>

        <div class="tab-content" id="pills-tabContent">
            <!-- Login -->
            <div class="tab-pane fade show active" id="pills-login" role="tabpanel">
                <form id="loginForm">
                    <div class="form-group mb-4">
                        <label><i class="fas fa-user-shield mr-2"></i>Staff ID</label>
                        <input type="text" class="form-control" id="username" placeholder="Username" required>
                    </div>
                    <div class="form-group mb-4">
                        <label><i class="fas fa-key mr-2"></i>Access Key</label>
                        <input type="password" class="form-control" id="password" placeholder="••••••••" required>
                    </div>
                    <button type="submit" class="btn btn-orange btn-block" id="loginBtn">Authorize System</button>
                    <div id="loginError" class="text-danger mt-3 text-center small font-weight-bold animate__animated animate__shakeX" style="display:none;"></div>
                </form>
            </div>

            <!-- Signup -->
            <div class="tab-pane fade" id="pills-signup" role="tabpanel">
                <form id="signupForm">
                    <div id="previewArea" style="display:none;">
                        <img src="" id="photoPreview">
                    </div>
                    <div class="form-group mb-3">
                        <label>Display Name</label>
                        <input type="text" class="form-control" id="signupName" placeholder="Full Name" required>
                    </div>
                    <div class="form-group mb-3">
                        <label>Preferred User ID</label>
                        <input type="text" class="form-control" id="signupUsername" placeholder="e.g. chef_john" required>
                    </div>
                    <div class="form-group mb-3">
                        <label>Security Key</label>
                        <input type="password" class="form-control" id="signupPassword" placeholder="Strong password" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label>Contact Email</label>
                            <input type="email" class="form-control" id="signupEmail" placeholder="name@pcnc.com" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>Phone Number</label>
                            <input type="text" class="form-control" id="signupPhone" placeholder="0712 345 678" required>
                        </div>
                    </div>
                    <div class="form-group mb-4">
                        <label>Identification Photo</label>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="signupPhoto" accept="image/*" required>
                            <label class="custom-file-label" id="photoLabel">Choose image</label>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-dark btn-block" id="signupBtn" style="border-radius: 16px; padding: 16px; font-weight: 800; text-transform: uppercase;">Submit Application</button>
                    <div id="signupMsg" class="mt-3 text-center small font-weight-bold"></div>
                </form>
            </div>
        </div>

        <div class="admin-footer">
            &copy; 2026 Kibby's Hot Kitchen | Operations Portal
        </div>
    </div>

    <script src="../assets/js/jquery-1.11.3.min.js"></script>
    <script src="../assets/bootstrap/js/bootstrap.min.js"></script>
    <script>
        const SessionManager = {
            getAllSessions() { const s = localStorage.getItem('adminSessions'); return s ? JSON.parse(s) : {}; },
            saveSession(id, data) {
                const s = this.getAllSessions();
                s[id] = { ...data, loginTime: new Date().toISOString(), lastActivity: new Date().toISOString() };
                localStorage.setItem('adminSessions', JSON.stringify(s));
            },
            setActiveSession(id) { sessionStorage.setItem('currentSessionId', id); }
        };

        // File to Base64
        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // Photo Preview
        document.getElementById('signupPhoto').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('photoLabel').innerText = file.name;
                const base64 = await toBase64(file);
                document.getElementById('photoPreview').src = base64;
                document.getElementById('previewArea').style.display = 'block';
            }
        });

        // Login Handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('loginBtn');
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const err = document.getElementById('loginError');

            btn.innerText = 'Verifying HQ...';
            btn.disabled = true;
            err.style.display = 'none';

            try {
                const res = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (data.success) {
                    SessionManager.saveSession(data.sessionId, {
                        token: data.token,
                        username: username,
                        staffName: data.staffName,
                        role: data.role,
                        profilePhoto: data.profilePhoto,
                        email: data.email || "",
                        phone: data.phone || ""
                    });
                    SessionManager.setActiveSession(data.sessionId);
                    window.location.href = 'dashboard.html';
                } else {
                    err.innerText = data.message || 'Access Denied';
                    err.style.display = 'block';
                    btn.innerText = 'Authorize System';
                    btn.disabled = false;
                }
            } catch (err) {
                btn.innerText = 'Authorize System'; btn.disabled = false;
            }
        });

        // Signup Handler
        document.getElementById('signupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('signupBtn');
            const msg = document.getElementById('signupMsg');
            const photoInput = document.getElementById('signupPhoto');
            
            let profilePhoto = "";
            if (photoInput.files[0]) {
                profilePhoto = await toBase64(photoInput.files[0]);
            }

            const data = {
                name: document.getElementById('signupName').value,
                username: document.getElementById('signupUsername').value,
                password: document.getElementById('signupPassword').value,
                email: document.getElementById('signupEmail').value,
                phone: document.getElementById('signupPhone').value,
                profilePhoto: profilePhoto
            };

            btn.innerText = 'Sending Application...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/admin/signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                msg.innerText = result.message;
                msg.className = `mt-3 text-center small font-weight-bold ${result.success ? 'text-success' : 'text-danger'}`;
                
                if (result.success) {
                    document.getElementById('signupForm').reset();
                    document.getElementById('previewArea').style.display = 'none';
                    setTimeout(() => { $('#pills-login-tab').tab('show'); }, 3000);
                }
                btn.innerText = 'Submit Application';
                btn.disabled = false;
            } catch (err) {
                msg.innerText = 'Server error'; msg.className = 'text-danger';
                btn.innerText = 'Submit Application'; btn.disabled = false;
            }
        });
    </script>
</body>
</html>
